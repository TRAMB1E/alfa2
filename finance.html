<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Планирование — Альфа</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --red: #ff3b30;
      --bg: #f2f2f2;
      --card-bg: #ffffff;
      --text-main: #111111;
      --text-sub: #868686;
      --shadow-soft: 0 8px 18px rgba(0, 0, 0, 0.08);
      --radius-card: 22px;
      --transition-fast: 0.25s ease-out;
    }

    * {
      box-sizing: border-box;
      -webkit-tap-highlight-color: transparent;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui,
        Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    /* Общий контейнер как на других экранах */
    .app {
      max-width: 390px;
      margin: auto;
      background: #ffffff;
      min-height: 100vh;
      padding: 16px 15px 90px;
      box-sizing: border-box;
    }

    /* HEADER как на analytics/study/lesson */
    .header {
      display: flex;
      align-items: center;
      font-weight: 700;
      font-size: 18px;
      margin-bottom: 10px;
    }

    .back-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      margin-right: 8px;
    }

    .back-btn svg {
      width: 22px;
      height: 22px;
    }

    /* fade-in, можно оставить лёгким эффектом */
    .fade-in-up {
      opacity: 0;
      transform: translateY(14px);
      transition: opacity 0.45s ease-out, transform 0.45s ease-out;
    }

    .fade-in-up.visible {
      opacity: 1;
      transform: translateY(0);
    }

    /* "Мой Аверест" */
    .section-heading {
      text-align: center;
      margin: 4px 0 10px;
      font-size: 22px;
      font-weight: 800;
      color: var(--red);
    }

    .everest-card {
      background: var(--red);
      border-radius: 24px;
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      position: relative;
      overflow: hidden;
      color: #fff;
      margin-bottom: 16px;
    }

    .everest-banner {
      background: linear-gradient(135deg, #ff6b5a, #ff3b30);
      border-radius: 999px;
      padding: 7px 16px;
      text-align: center;
      font-size: 12px;
      font-weight: 600;
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    .everest-banner::after {
      content: "";
      position: absolute;
      top: -100%;
      left: -40%;
      width: 40%;
      height: 300%;
      background: linear-gradient(
        120deg,
        transparent,
        rgba(255, 255, 255, 0.7),
        transparent
      );
      transform: translateX(-120%);
      animation: shimmer 3s infinite;
    }

    @keyframes shimmer {
      0% { transform: translateX(-120%); }
      60% { transform: translateX(260%); }
      100% { transform: translateX(260%); }
    }

    .everest-inner {
      position: relative;
      border-radius: 20px;
      overflow: hidden;
      background: #ff6041;
      height: 200px;
    }

    .everest-image {
      position: absolute;
      inset: 10px 40% 10px 10px;
      border-radius: 18px;
      background-image: url("everest-original.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }

    .everest-lines {
      position: absolute;
      inset: 16px 10px 16px 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
      z-index: 1;
    }

    .everest-row {
      display: flex;
      align-items: center;
      font-size: 10px;
      color: #ffd6c4;
    }

    .row-line {
      flex: 1;
      height: 2px;
      border-radius: 999px;
      background: rgba(255, 255, 255, 0.7);
      margin-right: 4px;
    }

    .row-label {
      width: 80px;
      text-align: right;
      font-weight: 600;
      letter-spacing: 0.02em;
    }

    .goal-star {
      position: absolute;
      font-size: 22px;
      color: rgba(255, 223, 166, 0.2);
      transform: scale(0.9);
      opacity: 0.7;
      transition: transform 0.25s ease-out, opacity 0.25s ease-out,
        color 0.25s ease-out, text-shadow 0.25s ease-out;
      z-index: 2;
      pointer-events: none;
    }

    .goal-star.on {
      color: #ffe77a;
      opacity: 1;
      transform: scale(1.15);
      text-shadow: 0 0 10px rgba(255, 231, 122, 0.95);
      animation: star-pop 0.35s ease-out;
    }

    @keyframes star-pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1.15); opacity: 1; }
    }

    .everest-image .goal-star[data-ratio="1"]    { top: 30%; left: 60%; }
    .everest-image .goal-star[data-ratio="0.8"]  { top: 38%; left: 73%; }
    .everest-image .goal-star[data-ratio="0.5"]  { top: 53%; left: 47%; }
    .everest-image .goal-star[data-ratio="0.3"]  { top: 67%; left: 59%; }
    .everest-image .goal-star[data-ratio="0.05"] { top: 80%; left: 22%; }

    /* Текст и цель */
    .info-block {
      margin-bottom: 8px;
      font-size: 13px;
      color: var(--text-sub);
    }

    .info-block strong {
      display: block;
      color: var(--text-main);
      font-size: 16px;
      margin-top: 2px;
    }

    .info-inline {
      display: flex;
      justify-content: space-between;
      align-items: baseline;
      font-size: 13px;
      color: var(--text-sub);
      margin-bottom: 10px;
      background: #ffffff;
      padding: 10px 14px;
      border-radius: 14px;
      box-shadow: 0 4px 10px rgba(0, 0, 0, 0.04);
    }

    .info-inline strong {
      color: var(--text-main);
      font-size: 14px;
    }

    .goal-card {
      margin-bottom: 14px;
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      font-size: 12px;
      color: var(--text-sub);
    }

    .goal-row {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
    }

    .goal-row label {
      font-size: 13px;
      color: var(--text-main);
      font-weight: 600;
    }

    .goal-input-wrap {
      position: relative;
      flex: 1;
    }

    #goalInput {
      width: 100%;
      padding: 6px 26px 6px 8px;
      border-radius: 10px;
      border: 1px solid #dddde3;
      font-size: 13px;
      outline: none;
      text-align: right;
    }

    #goalInput:focus {
      border-color: var(--red);
      box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.2);
    }

    .goal-input-wrap span {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--text-sub);
    }

    .goal-hint {
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-sub);
    }

    /* Универсальная карточка (календарь, график) */
    .card {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: 12px 12px 10px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 14px;
    }

    /* Календарь */
    .calendar-header {
      text-align: center;
      margin-bottom: 8px;
      font-weight: 700;
      color: var(--text-main);
      font-size: 14px;
    }

    .calendar-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      text-align: center;
      table-layout: fixed;
    }

    .calendar-grid th {
      padding: 5px 2px;
      font-weight: 600;
      color: #ffffff;
      background: var(--red);
      border-bottom: 1px solid #f27b71;
    }

    .calendar-grid td {
      padding: 5px 0;
      height: 30px;
      position: relative;
      background: #fff;
    }

    .calendar-grid tr:nth-child(n + 3) td {
      border-top: 1px solid #f4f4f6;
    }

    .calendar-grid td button.day {
      border: none;
      background: transparent;
      width: 26px;
      height: 26px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast), color var(--transition-fast),
        transform 0.16s ease-out;
    }

    .calendar-grid td button.day.selected {
      background: var(--red);
      color: #fff;
      box-shadow: 0 4px 8px rgba(255, 59, 48, 0.36);
      transform: translateY(-1px);
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 3px;
    }

    .dot.salary { background: #09b35c; }
    .dot.dividends { background: #ff2d92; }
    .dot.deposit { background: #7b61ff; }
    .dot.other { background: #ff9500; }

    .calendar-legend {
      display: flex;
      flex-wrap: wrap;
      row-gap: 4px;
      column-gap: 16px;
      margin-top: 6px;
      font-size: 11px;
      color: var(--text-sub);
      justify-content: center;
    }

    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 5px;
    }

    .legend-marker {
      width: 10px;
      height: 10px;
      border-radius: 50%;
    }

    .legend-marker.salary { background: #09b35c; }
    .legend-marker.dividends { background: #ff2d92; }
    .legend-marker.deposit { background: #7b61ff; }
    .legend-marker.other { background: #ff9500; }

    /* График */
    .chart-title {
      font-size: 12px;
      color: var(--text-sub);
      margin-bottom: 6px;
      padding-left: 2px;
    }

    .chart-wrapper {
      background: #181818;
      border-radius: 18px;
      padding: 12px 14px 18px;
      color: #fff;
      position: relative;
      overflow: hidden;
    }

    .chart-grid-lines {
      position: absolute;
      inset: 20px 16px 38px 36px;
      pointer-events: none;
    }

    .chart-grid-lines::before,
    .chart-grid-lines::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .chart-y-labels {
      position: absolute;
      left: 10px;
      top: 24px;
      bottom: 42px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(255, 255, 255, 0.5);
    }

    svg#line-chart {
      width: 100%;
      height: 120px;
      display: block;
    }

    .chart-line {
      stroke: #f9d24a;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 400;
      stroke-dashoffset: 400;
      transition: stroke-dashoffset 1.3s ease-out;
    }

    .chart-point {
      stroke: #181818;
      stroke-width: 2;
      transition: r 0.3s ease-out;
    }

    .chart-point.salary { fill: #09b35c; }
    .chart-point.dividends { fill: #ff2d92; }
    .chart-point.other { fill: #ff9500; }

    .chart-wrapper.loaded .chart-line {
      stroke-dashoffset: 0;
    }

    .chart-wrapper.loaded .chart-point {
      r: 5;
    }

    .chart-x-days {
      position: absolute;
      left: 36px;
      right: 16px;
      bottom: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(255, 255, 255, 0.6);
    }

    .chart-x-label {
      margin-top: 4px;
      font-size: 10px;
      color: rgba(255, 255, 255, 0.6);
      text-align: right;
    }

    /* Рекомендации */
    .reco-card {
      background: #fff9f3;
      border-radius: 20px;
      padding: 14px 14px 16px;
      box-shadow: var(--shadow-soft);
      color: var(--text-main);
      font-size: 12px;
      line-height: 1.45;
    }

    .reco-title {
      color: var(--red);
      font-weight: 700;
      font-size: 13px;
      margin-bottom: 6px;
      text-align: center;
    }

    .reco-body {
      padding-top: 2px;
    }

    .reco-body strong {
      font-weight: 600;
    }

    /* Toast (если оставляем) */
    .toast {
      position: fixed;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%) translateY(40px);
      max-width: 390px;
      width: calc(100% - 60px);
      padding: 8px 12px;
      background: #000;
      color: #fff;
      border-radius: 999px;
      font-size: 11px;
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      z-index: 999;
      pointer-events: none;
    }

    .toast.visible {
      opacity: 1;
      transform: translateX(-50%) translateY(0);
    }

    /* ===== НИЖНЕЕ МЕНЮ КАК НА ГЛАВНОМ ЭКРАНЕ ===== */
    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 390px;
      margin: auto;
      background: #ffffff;
      height: 60px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-sizing: border-box;
    }

    .nav-item {
      font-size: 9px;
      text-align: center;
      color: #999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .nav-item.active {
      color: #000;
      font-weight: 700;
    }

    .nav-icon {
      width: 18px;
      height: 18px;
    }

    .nav-icon svg {
      width: 100%;
      height: 100%;
      fill: currentColor;
    }
  </style>
</head>
<body>

<div class="app">
  <!-- HEADER -->
  <header class="header">
    <button class="back-btn" id="backButton" aria-label="Назад">
      <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="20" y1="12" x2="4" y2="12"/>
        <polyline points="10 6 4 12 10 18"/>
      </svg>
    </button>
    <span>Планирование</span>
  </header>

  <main>
    <h1 class="section-heading fade-in-up">Мой Аверест</h1>

    <section class="everest-card fade-in-up">
      <div class="everest-banner">
        До новой машины осталось всего 2 зарплаты! Так держать!
      </div>

      <div class="everest-inner">
        <div class="everest-image">
          <div class="goal-star" data-ratio="1">★</div>
          <div class="goal-star" data-ratio="0.8">★</div>
          <div class="goal-star" data-ratio="0.5">★</div>
          <div class="goal-star" data-ratio="0.3">★</div>
          <div class="goal-star" data-ratio="0.05">★</div>
        </div>

        <div class="everest-lines">
          <div class="everest-row" data-ratio="1">
            <div class="row-line"></div>
            <div class="row-label amount-label"></div>
          </div>
          <div class="everest-row" data-ratio="0.8">
            <div class="row-line"></div>
            <div class="row-label amount-label"></div>
          </div>
          <div class="everest-row" data-ratio="0.5">
            <div class="row-line"></div>
            <div class="row-label amount-label"></div>
          </div>
          <div class="everest-row" data-ratio="0.3">
            <div class="row-line"></div>
            <div class="row-label amount-label"></div>
          </div>
          <div class="everest-row" data-ratio="0.05">
            <div class="row-line"></div>
            <div class="row-label amount-label"></div>
          </div>
        </div>
      </div>
    </section>

    <div class="info-block fade-in-up">
      Планируемые поступления на январь:
      <strong id="plannedAmountText">320 000,00 ₽</strong>
    </div>

    <div class="info-inline fade-in-up">
      <span>Ближайшее зачисление 17 января</span>
      <strong>100 000,00 ₽</strong>
    </div>

    <section class="goal-card fade-in-up">
      <div class="goal-row">
        <label for="goalInput">Цель</label>
        <div class="goal-input-wrap">
          <input id="goalInput" type="text" inputmode="numeric" value="1000000" />
          <span>₽</span>
        </div>
      </div>
      <div class="goal-hint">
        Введите сумму цели. Метки справа от горы и звёзды будут пересчитаны от этой суммы.
      </div>
    </section>

    <!-- Календарь -->
    <section class="card fade-in-up">
      <div class="calendar-header">Январь</div>
      <table class="calendar-grid" aria-label="Календарь января">
        <thead>
        <tr>
          <th>П</th><th>В</th><th>С</th><th>Ч</th><th>П</th><th>С</th><th>В</th>
        </tr>
        </thead>
        <tbody>
        <tr>
          <td></td><td></td>
          <td><button class="day">1</button></td>
          <td><button class="day">2</button></td>
          <td><button class="day">3</button></td>
          <td><button class="day">4</button></td>
          <td><button class="day">5</button></td>
        </tr>
        <tr>
          <td>
            <button class="day" data-type="salary" data-amount="10000">
              6<span class="dot salary"></span>
            </button>
          </td>
          <td><button class="day">7</button></td>
          <td><button class="day">8</button></td>
          <td><button class="day">9</button></td>
          <td><button class="day">10</button></td>
          <td><button class="day">11</button></td>
          <td><button class="day">12</button></td>
        </tr>
        <tr>
          <td><button class="day">13</button></td>
          <td><button class="day">14</button></td>
          <td><button class="day">15</button></td>
          <td><button class="day">16</button></td>
          <td>
            <button class="day" data-type="salary" data-amount="52000">
              17<span class="dot salary"></span>
            </button>
          </td>
          <td><button class="day">18</button></td>
          <td>
            <button class="day" data-type="other" data-amount="20000">
              19<span class="dot other"></span>
            </button>
          </td>
        </tr>
        <tr>
          <td><button class="day">20</button></td>
          <td><button class="day">21</button></td>
          <td><button class="day">22</button></td>
          <td><button class="day">23</button></td>
          <td><button class="day">24</button></td>
          <td>
            <button class="day" data-type="dividends" data-amount="100000">
              25<span class="dot dividends"></span>
            </button>
          </td>
          <td><button class="day">26</button></td>
        </tr>
        <tr>
          <td><button class="day">27</button></td>
          <td><button class="day">28</button></td>
          <td><button class="day">29</button></td>
          <td><button class="day">30</button></td>
          <td><button class="day">31</button></td>
          <td></td><td></td>
        </tr>
        </tbody>
      </table>

      <div class="calendar-legend">
        <div class="legend-item"><span class="legend-marker salary"></span>Зарплата</div>
        <div class="legend-item"><span class="legend-marker dividends"></span>Дивиденды</div>
        <div class="legend-item"><span class="legend-marker deposit"></span>% по вкладам</div>
        <div class="legend-item"><span class="legend-marker other"></span>Прочее</div>
      </div>
    </section>

    <!-- График -->
    <section class="card fade-in-up">
      <div class="chart-title">Изменения баланса</div>
      <div class="chart-wrapper" id="chartWrapper">
        <div class="chart-grid-lines"></div>
        <div class="chart-y-labels">
          <span>100 000</span>
          <span>52 000</span>
          <span>10 000</span>
          <span>1 000</span>
        </div>
        <svg id="line-chart" viewBox="0 0 260 120" role="img">
          <polyline id="balanceLine" class="chart-line" points=""></polyline>
          <g id="balancePoints"></g>
        </svg>
        <div class="chart-x-days" id="chartDays"></div>
        <div class="chart-x-label">Дни</div>
      </div>
    </section>

    <!-- Рекомендации -->
    <section class="reco-card fade-in-up">
      <div class="reco-title">Рекомендации по использованию будущих средств:</div>
      <div class="reco-body">
        У вас сейчас стабильный приток средств. Рекомендуем направить часть
        будущих поступлений в накопления — от <strong>10% до 20%</strong>.
        Также можно увеличить долю инвестиций, чтобы ускорить рост капитала.
        Подумайте о создании финансовой подушки на
        <strong>3–6 месяцев</strong> расходов.
      </div>
    </section>
  </main>
</div>

<!-- НИЖНЯЯ ПАНЕЛЬ КАК НА ГЛАВНОМ -->
<nav class="navbar">
  <div class="nav-item active">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/>
      </svg>
    </div>
    <div class="nav-label">Главная</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20 7H4V5h16v2zm0 4H4V9h16v2zm0 4H4v-2h16v2zm0 4H4v-2h16v2z"/>
      </svg>
    </div>
    <div class="nav-label">Платежи</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6.02 4.02 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 17.98 4 20 6.02 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </div>
    <div class="nav-label">Выгода</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M11 7h2v6h-2V7zm1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-18C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
    </div>
    <div class="nav-label">История</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 4h16v10H5.17L4 15.17V4zm0-2C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4z"/>
      </svg>
    </div>
    <div class="nav-label">Чаты</div>
  </div>
</nav>

<div class="toast" id="toast"></div>

<script>
  const backButton = document.getElementById("backButton");
  const chartWrapper = document.getElementById("chartWrapper");
  const toast = document.getElementById("toast");

  const goalInput = document.getElementById("goalInput");
  const amountRows = Array.from(document.querySelectorAll(".everest-row"));
  const goalStars = Array.from(document.querySelectorAll(".goal-star"));
  const plannedAmountText = document.getElementById("plannedAmountText");

  const balanceLine = document.getElementById("balanceLine");
  const balancePointsGroup = document.getElementById("balancePoints");
  const chartDaysContainer = document.getElementById("chartDays");

  const CHART_LEFT = 36;
  const CHART_RIGHT = 244;
  const CHART_BOTTOM = 104;
  const CHART_TOP = 24;

  const CURRENT_AMOUNT = 320000;

  function formatRuble(num) {
    const n = Number(num) || 0;
    return n.toLocaleString("ru-RU") + " ₽";
  }

  function parseNumberFromInput(value) {
    if (!value) return 0;
    const digits = value.toString().replace(/\D/g, "");
    return Number(digits || 0);
  }

  function recalcGoal() {
    const goal = parseNumberFromInput(goalInput.value) || 0;
    goalInput.value = goal ? goal.toLocaleString("ru-RU") : "";

    amountRows.forEach((row) => {
      const ratio = parseFloat(row.dataset.ratio);
      const label = row.querySelector(".amount-label");
      if (!label || !ratio) return;
      const threshold = Math.round(goal * ratio);
      label.textContent = threshold ? formatRuble(threshold) : "0 ₽";
      row.dataset.threshold = threshold;
    });

    goalStars.forEach((star) => {
      const ratio = parseFloat(star.dataset.ratio);
      const threshold = Math.round(goal * ratio);
      star.dataset.threshold = threshold;
      if (CURRENT_AMOUNT >= threshold && threshold > 0) {
        star.classList.add("on");
      } else {
        star.classList.remove("on");
      }
    });
  }

  function buildChartFromCalendar() {
    const dayButtons = Array.from(
      document.querySelectorAll(".calendar-grid .day[data-amount]")
    );

    const events = [];
    dayButtons.forEach((btn) => {
      const day = Number(btn.textContent.trim());
      const amount = Number(btn.dataset.amount || 0);
      const type = btn.dataset.type || "other";
      if (!day || !amount) return;
      events.push({ day, amount, type });
    });

    if (!events.length) {
      balanceLine.setAttribute("points", "");
      balancePointsGroup.innerHTML = "";
      chartDaysContainer.innerHTML = "";
      return;
    }

    events.sort((a, b) => a.day - b.day);

    const maxDay = events[events.length - 1].day;
    const maxAmount = Math.max(...events.map(e => e.amount));
    const minAxis = 1000;

    const width = CHART_RIGHT - CHART_LEFT;
    const height = CHART_BOTTOM - CHART_TOP;
    const amountRange = (maxAmount - minAxis) || 1;

    function yForAmount(amount) {
      const clamped = Math.max(minAxis, amount);
      const ratio = (clamped - minAxis) / amountRange;
      return CHART_BOTTOM - ratio * height;
    }

    const circlesData = events.map(e => {
      const x = CHART_LEFT + (e.day / maxDay) * width;
      const y = yForAmount(e.amount);
      return { x, y, type: e.type, day: e.day };
    });

    const linePoints = circlesData
      .map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`)
      .join(" ");
    balanceLine.setAttribute("points", linePoints);

    balancePointsGroup.innerHTML = "";
    const svgNS = "http://www.w3.org/2000/svg";
    circlesData.forEach((p) => {
      const c = document.createElementNS(svgNS, "circle");
      c.setAttribute("cx", p.x.toFixed(1));
      c.setAttribute("cy", p.y.toFixed(1));
      c.setAttribute("r", "4");
      c.setAttribute("class", `chart-point ${p.type}`);
      balancePointsGroup.appendChild(c);
    });

    chartDaysContainer.innerHTML = "";
    circlesData.forEach((p) => {
      const span = document.createElement("span");
      span.textContent = p.day;
      chartDaysContainer.appendChild(span);
    });
  }

  // стрелка "назад" -> index.html
  backButton.addEventListener("click", () => {
    window.location.href = "index.html";
  });

  window.addEventListener("DOMContentLoaded", () => {
    document.querySelectorAll(".fade-in-up").forEach((el, i) => {
      setTimeout(() => el.classList.add("visible"), 120 * i);
    });

    plannedAmountText.textContent = formatRuble(CURRENT_AMOUNT);

    recalcGoal();
    buildChartFromCalendar();

    setTimeout(() => chartWrapper.classList.add("loaded"), 700);
  });

  goalInput.addEventListener("input", recalcGoal);

  let toastTimeout;
  function showToast(message, duration = 2100) {
    toast.textContent = message;
    toast.classList.add("visible");
    clearTimeout(toastTimeout);
    toastTimeout = setTimeout(() => {
      toast.classList.remove("visible");
    }, duration);
  }

  const daysEls = document.querySelectorAll(".calendar-grid .day");
  daysEls.forEach((btn) => {
    btn.addEventListener("click", () => {
      daysEls.forEach((b) => b.classList.remove("selected"));
      btn.classList.add("selected");

      const type = btn.dataset.type;
      if (!type) return;
      let text;
      switch (type) {
        case "salary": text = "Зачисление зарплаты"; break;
        case "dividends": text = "Выплата дивидендов"; break;
        case "other": text = "Прочее поступление средств"; break;
      }
      if (text) showToast(text);
    });
  });
</script>

</body>
</html>
