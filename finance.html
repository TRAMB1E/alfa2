<!DOCTYPE html>
<html lang="ru" style="overflow:hidden; overflow-x:hidden; overflow-y:hidden;">
<head>
  <meta charset="UTF-8" />
  <title>Планирование — Альфа</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --red: #ff3b30;
      --bg: #f3f3f5;
      --card-bg: #ffffff;
      --text-main: #111111;
      --text-sub: #868686;
      --shadow-soft: 0 8px 18px rgba(0, 0, 0, 0.08);
      --radius-card: 22px;
      --transition-fast: 0.25s ease-out;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    html, body {
      width: 100%;
      height: 100%;
      overflow: hidden;
      overscroll-behavior: none;
    }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Roboto, sans-serif;
      background: var(--bg);
      color: var(--text-main);
    }

    .app-shell {
      max-width: 390px;
      margin: 0 auto;
      background: #ffffff;
      width: 100%;
      height: 100vh;
      display: flex;
      flex-direction: column;
      position: relative;
      overflow: hidden;
    }

    .app-scroll {
      flex: 1;
      overflow-y: auto;
      overflow-x: hidden;
      padding: 14px 18px calc(60px + env(safe-area-inset-bottom));
      scrollbar-width: none; /* Firefox */
      -ms-overflow-style: none; /* IE/Edge */
      overscroll-behavior: contain;
      -webkit-overflow-scrolling: touch;
      touch-action: pan-y;
    }
    
    /* top bar */
    .top-bar {
      display: flex; align-items: center; gap: 12px;
      padding: 8px 18px 0;
      background: #ffffff;
      position: sticky; top: 0; z-index: 10;
    }
    .back-btn {
      width: 32px;
      height: 32px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      border: none;
      background: none;
      padding: 0;
      margin-right: 8px;
    }

    .back-btn svg {
      width: 22px;
      height: 22px;
    }

    .top-title { font-weight: 700; font-size: 22px; color: var(--text-main); }

        /* fade-in animation отключена */
    .fade-in-up { opacity: 1; transform: none; transition: none; }
/* screens */
    .screens { position: relative; overflow-x: hidden; }
    .screen { opacity: 0; transform: translateX(12px); pointer-events: none; transition: opacity 0.24s ease-out, transform 0.24s ease-out; }
    .screen.active { opacity: 1; transform: translateX(0); pointer-events: auto; }

    .screen-placeholder { padding-top: 40px; text-align: center; color: var(--text-sub); font-size: 14px; }
    .screen-placeholder h2 { font-size: 20px; margin-bottom: 8px; color: var(--text-main); }

    /* Everest */
    .section-heading {
      text-align: center; margin: 10px 0 6px;
      font-size: 26px; font-weight: 800; color: var(--red);
    }

    .goal-title {
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      color: #222;
      margin: 0 0 10px;
    }

    .everest-card {
      background: var(--red);
      border-radius: 28px;
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      color: #fff;
      margin-bottom: 14px;
    }

    .everest-banner {
      background: linear-gradient(135deg, #ff6b5a, #ff3b30);
      border-radius: 999px;
      padding: 8px 18px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    /* плавная подсветка + размытые границы блика */
    .everest-banner::after {
      content: "";
      position: absolute;
      top: -120%;
      left: -45%;
      width: 55%;
      height: 320%;
      background: radial-gradient(
        circle at 50% 50%,
        rgba(255, 255, 255, 0.85),
        rgba(255, 255, 255, 0.25),
        transparent 70%
      );
      filter: blur(6px);
      transform: translateX(-180%);
      animation: shimmer 4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shimmer {
      0%   { transform: translateX(-180%); opacity: 0; }
      15%  { opacity: 1; }
      70%  { transform: translateX(260%); opacity: 1; }
      100% { transform: translateX(260%); opacity: 0; }
    }

    .savings-pill {
      background: rgba(255,255,255,0.92);
      color: #111;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0 auto 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }
    .savings-pill .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #09b35c;
      position: static; transform: none;
    }

    .progress-line {
      text-align:center;
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      font-weight: 800;
    }

    .everest-inner {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: #ff6041;
      height: 220px;
    }

    .everest-image {
      position: absolute;
      inset: 10px 40% 10px 10px;
      border-radius: 22px;
      background-image: url("everest-original.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }

    .everest-lines {
      position: absolute;
      inset: 16px 10px 16px 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
      z-index: 1;
    }

    .everest-row { display: flex; align-items: center; font-size: 11px; color: #ffd6c4; }
    .row-line { flex: 1; height: 2px; border-radius: 999px; background: rgba(255,255,255,0.7); margin-right: 4px; }
    .row-label { width: 96px; text-align: right; font-weight: 900; letter-spacing: 0.02em; }

    .goal-star {
      position: absolute;
      font-size: 26px;
      color: rgba(255, 223, 166, 0.2);
      text-shadow: 0 0 0 transparent;
      transform: scale(0.9);
      opacity: 0.7;
      transition: transform 0.25s ease-out, opacity 0.25s ease-out, color 0.25s ease-out, text-shadow 0.25s ease-out;
      z-index: 2;
      pointer-events: none;
    }
    .goal-star.on {
      color: #ffe77a;
      opacity: 1;
      transform: scale(1.15);
      text-shadow: 0 0 10px rgba(255, 231, 122, 0.95);
      animation: star-pop 0.35s ease-out;
    }
    .goal-star.on.delay-0 { animation-delay: 0ms; }
    .goal-star.on.delay-1 { animation-delay: 120ms; }
    .goal-star.on.delay-2 { animation-delay: 240ms; }
    .goal-star.on.delay-3 { animation-delay: 360ms; }
    .goal-star.on.delay-4 { animation-delay: 480ms; }

    @keyframes star-pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1.15); opacity: 1; }
    }

    .everest-image .goal-star[data-ratio="1"]    { top: 30%; left: 60%; }
    .everest-image .goal-star[data-ratio="0.8"]  { top: 38%; left: 73%; }
    .everest-image .goal-star[data-ratio="0.5"]  { top: 53%; left: 47%; }
    .everest-image .goal-star[data-ratio="0.3"]  { top: 67%; left: 59%; }
    .everest-image .goal-star[data-ratio="0.05"] { top: 80%; left: 22%; }

    .info-block { margin-bottom: 10px; font-size: 13px; color: var(--text-sub); padding: 0 14px; }
    .info-block strong { display: block; color: var(--text-main); font-size: 16px; margin-top: 2px; }

    .info-inline {
      display: flex; justify-content: space-between; align-items: baseline;
      font-size: 13px; color: var(--text-sub);
      margin-bottom: 8px;
      background: #ffffff;
      padding: 10px 14px;
      border-radius: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.04);
    }
    .info-inline strong { color: var(--text-main); font-size: 14px; }

    .goal-card {
      margin-bottom: 12px;
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      font-size: 12px;
      color: var(--text-sub);
    }
    .goal-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .goal-row label { font-size: 13px; color: var(--text-main); font-weight: 900; }

    .goal-input-wrap { position: relative; flex: 1; }
    .input {
      width: 100%;
      padding: 8px 26px 8px 8px;
      border-radius: 10px;
      border: 1px solid #dddde3;
      font-size: 13px;
      outline: none;
      text-align: right;
      background: #f5f5f7;
      color: #777;
    }
    .input.editing {
      background: #fff;
      color: #111;
      border-color: var(--red);
      box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.18);
    }
    .input:disabled { opacity: 1; }

    .goal-input-wrap span {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--text-sub);
    }

    .goal-actions {
      display: flex;
      gap: 8px;
      margin-left: 6px;
      flex-shrink: 0;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.15s ease-out, opacity 0.15s ease-out;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active { transform: scale(0.96); }
    .btn.primary { background: var(--red); color: #fff; }
    .btn.ghost { background: #f0f0f3; color: #111; }
    .btn.hidden { display: none; }

    .goal-hint { margin-top: 6px; font-size: 11px; color: var(--text-sub); }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 18px;
    }

    /* Calendar header with month switch */
    .calendar-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }
    .calendar-header {
      text-align: center;
      font-weight: 900;
      color: var(--text-main);
      flex: 1;
    }
    .month-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      cursor: pointer;
      font-size: 16px;
      font-weight: 900;
      color: #111;
    }
    .month-btn:active { transform: scale(0.95); }

    .calendar-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      text-align: center;
      table-layout: fixed;
    }
    .calendar-grid th {
      padding: 6px 2px;
      font-weight: 900;
      color: #ffffff;
      background: var(--red);
      border-bottom: 1px solid #f27b71;
    }
    .calendar-grid td {
      padding: 6px 0;
      height: 32px;
      position: relative;
      background: #fff;
    }
    .calendar-grid tr:nth-child(n + 3) td { border-top: 1px solid #f4f4f6; }

    .calendar-grid td button.day {
      border: none;
      background: transparent;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast), color var(--transition-fast), transform 0.16s ease-out;
    }
    .calendar-grid td button.day.selected {
      background: var(--red);
      color: #fff;
      box-shadow: 0 4px 8px rgba(255, 59, 48, 0.36);
      transform: translateY(-1px);
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 3px;
    }
    .dot.salary { background: #09b35c; }
    .dot.dividends { background: #ff2d92; }
    .dot.deposit { background: #7b61ff; }
    .dot.other { background: #ff9500; }

    .calendar-legend {
      display: flex;
      flex-wrap: wrap;
      row-gap: 4px;
      column-gap: 16px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
      justify-content: center;
    }
    .legend-item { display: inline-flex; align-items: center; gap: 5px; }
    .legend-marker { width: 10px; height: 10px; border-radius: 50%; }
    .legend-marker.salary { background: #09b35c; }
    .legend-marker.dividends { background: #ff2d92; }
    .legend-marker.deposit { background: #7b61ff; }
    .legend-marker.other { background: #ff9500; }

    /* chart */
    .chart-title { font-size: 12px; color: var(--text-sub); margin-bottom: 8px; padding-left: 2px; }
    .chart-wrapper {
      background: #181818;
      border-radius: 20px;
      padding: 14px 16px 20px;
      color: #fff;
      position: relative;
      overflow: hidden;
    }
    .chart-grid-lines { position: absolute; inset: 20px 16px 38px 36px; pointer-events: none; }
    .chart-grid-lines::before,
    .chart-grid-lines::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .chart-y-labels {
      position: absolute;
      left: 10px;
      top: 24px;
      bottom: 42px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(255, 255, 255, 0.5);
    }
    svg#line-chart { width: 100%; height: 120px; display: block; }
    .chart-line {
      stroke: #f9d24a;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 400;
      stroke-dashoffset: 400;
      transition: stroke-dashoffset 1.3s ease-out;
    }
    .chart-point { stroke: #181818; stroke-width: 2; transition: r 0.3s ease-out; }
    .chart-point.salary { fill: #09b35c; }
    .chart-point.dividends { fill: #ff2d92; }
    .chart-point.other { fill: #ff9500; }
    .chart-wrapper.loaded .chart-line { stroke-dashoffset: 0; }
    .chart-wrapper.loaded .chart-point { r: 5; }
    .chart-x-days {
      position: absolute;
      left: 36px;
      right: 16px;
      bottom: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(255, 255, 255, 0.6);
    }
    .chart-x-label { margin-top: 4px; font-size: 10px; color: rgba(255, 255, 255, 0.6); text-align: right; }

    /* recommendations */
    .reco-card {
      background: #fff9f3;
      border-radius: 22px;
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      color: var(--text-main);
      font-size: 12px;
      line-height: 1.45;
      margin-bottom: 12px;
    }
    .reco-title { color: var(--red); font-weight: 900; font-size: 13px; margin-bottom: 6px; text-align: center; }
    .reco-body { padding-top: 4px; }
    .reco-body strong { font-weight: 700; }

    /* forecast */
    .forecast-card {
      background: #ffffff;
      border-radius: 22px;
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 0;
    }
    .forecast-title {
      color: var(--text-main);
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 8px;
      text-align: center;
    }

    .forecast-meta {
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .reach-date {
      font-size: 11px;
      color: var(--text-sub);
      font-weight: 700;
      flex: 1;
      min-width: 220px;
      text-align: left;
    }

    /* toggle */
    .segmented {
      display:inline-flex;
      background:#f2f2f5;
      border-radius:999px;
      padding:3px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
    }
    .segmented button{
      border:none;
      background: transparent;
      padding:7px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight: 900;
      color:#444;
      cursor:pointer;
      transition: transform .15s ease-out, background .2s ease-out, color .2s ease-out;
    }
    .segmented button:active{ transform: scale(0.98); }
    .segmented button.active{
      background:#fff;
      color:#111;
      box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }

    .forecast-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
    }
    .forecast-table {
      width: 100%;
      min-width: 560px;
      border-collapse: collapse;
      font-size: 12px;
    }
    .forecast-table th {
      text-align: left;
      padding: 10px 10px;
      color: #fff;
      background: var(--red);
      font-weight: 900;
      position: sticky;
      top: 0;
    }
    .forecast-table td {
      padding: 10px 10px;
      border-bottom: 1px solid #f0f0f3;
      white-space: nowrap;
      color: #222;
      font-weight: 700;
    }

    .forecast-row-goal {
      background: rgba(255, 59, 48, 0.07);
      position: relative;
      animation: goalPulse 2.2s ease-in-out infinite;
    }
    @keyframes goalPulse{
      0%{ box-shadow: inset 0 0 0 rgba(255,59,48,0); }
      50%{ box-shadow: inset 0 0 0 999px rgba(255,59,48,0.03); }
      100%{ box-shadow: inset 0 0 0 rgba(255,59,48,0); }
    }

    .forecast-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
    }
    .badge-ok { background: rgba(9,179,92,0.12); color: #067a3e; }
    .badge-goal { background: rgba(255,59,48,0.12); color: #b81f17; }

    .forecast-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.35;
      text-align: center;
    }

    /* ===== НИЖНЕЕ МЕНЮ КАК НА ГЛАВНОМ ЭКРАНЕ ===== */
    .navbar {
      position: fixed;
      bottom: 0;
      left: 0;
      right: 0;
      max-width: 390px;
      margin: 0 auto;
      background: #ffffff;
      height: 60px;
      border-top: 1px solid #ddd;
      display: flex;
      justify-content: space-around;
      align-items: center;
      box-sizing: border-box;
    }

    .nav-item {
      font-size: 9px;
      pointer-events: none;
      text-align: center;
      color: #999;
      display: flex;
      flex-direction: column;
      align-items: center;
      gap: 2px;
    }

    .nav-item.active {
      color: #000;
      font-weight: 700;
    }

    .nav-icon {
      width: 18px;
      height: 18px;
    }

    .nav-icon svg {
      width: 100%;
      height: 100%;
      fill: currentColor;
    }
  



    .toast {
      position: fixed;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%) translateY(40px);
      max-width: 420px;
      width: calc(100% - 80px);
      padding: 10px 14px;
      background: #000;
      color: #fff;
      border-radius: 999px;
      font-size: 12px;
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      z-index: 999;
      pointer-events: none;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    @media (max-width: 360px) {
      .section-heading { font-size: 22px; }
      .everest-card { padding: 12px 12px 14px; }
      .info-inline { font-size: 12px; padding: 8px 10px; }
      .info-block strong { font-size: 14px; }
      .btn { padding: 7px 10px; font-size: 11px; }
      .reach-date { min-width: 160px; }
    }
  
    /* Hide internal scrollbars (WebKit) */
    
    /* Hide internal scrollbars (WebKit/Blink) */
    .app-scroll::-webkit-scrollbar { display: none; width: 0 !important; height: 0 !important; }
    .app-scroll::-webkit-scrollbar-thumb { background: transparent; }
    .app-scroll { scrollbar-gutter: auto; }


/* ===== Minimal input cards (накопления/цель/зарплата) ===== */
.goal-card{
  background: transparent !important;
  box-shadow: none !important;
  padding: 0 !important;
  border-radius: 0 !important;
}
.goal-row{
  background: #fff;
  border-radius: 16px;
  padding: 12px 12px;
  box-shadow: none;
  border: 1px solid rgba(0,0,0,0.06);
}
.goal-row label{
  font-weight: 800;
  font-size: 13px;
}
.goal-input-wrap{
  background: transparent;
}
.input{
  background: transparent !important;
  border: none !important;
  padding: 0 18px 0 0 !important;
  border-radius: 0 !important;
  font-size: 15px !important;
  font-weight: 800 !important;
  color: #111 !important;
}
.input:disabled{
  background: transparent !important;
  color: #111 !important;
}
.input.editing{
  box-shadow: none !important;
  border: none !important;
  outline: 2px solid rgba(255,59,48,0.25);
  outline-offset: 6px;
  border-radius: 10px !important;
  padding: 8px 26px 8px 8px !important;
  background: #fff !important;
}
.goal-input-wrap span{
  right: 0 !important;
  color: rgba(17,17,17,0.55) !important;
  font-weight: 800;
}
.goal-actions{
  gap: 6px !important;
}
.btn.ghost{
  background: transparent !important;
  color: #111 !important;
  padding: 7px 10px !important;
}
.btn.primary{
  padding: 7px 10px !important;
}

/* ===== Chart X axis labels positioned by day ===== */
.chart-x-days{
  position: absolute !important;
  left: 36px !important;
  right: 16px !important;
  bottom: 8px !important;
  height: 14px !important;
  display: block !important;
}
.chart-x-days span{
  position: absolute !important;
  transform: translateX(-50%);
}

</style>
</head>

<body style="overflow:hidden; overflow-x:hidden; overflow-y:hidden;" style="overflow:hidden; overflow-x:hidden; overflow-y:hidden; touch-action:none;">
  <div class="app-shell" id="appShell">
    <header class="top-bar">
      <button class="back-btn" id="backButton" aria-label="Назад">
      <svg viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
        <line x1="20" y1="12" x2="4" y2="12"/>
        <polyline points="10 6 4 12 10 18"/>
      </svg>
    </button>
      <div class="top-title" id="topTitle">Планирование</div>
    </header>

    <main class="app-scroll">
      <div class="screens">
        <!-- HOME -->
        <section class="screen screen-home active" data-tab="home">
          <h1 class="section-heading fade-in-up">Мой Аверест</h1>
          <div class="goal-title fade-in-up" id="goalTitleTop">Цель — 1 000 000 ₽</div>

          <section class="everest-card fade-in-up">
            <div class="everest-banner" id="everestBannerText">
              До новой машины осталось всего 2 зарплаты! Так держать!
            </div>

            <div style="display:flex; justify-content:center;">
              <div class="savings-pill" id="savingsPill">
                <span class="dot"></span>
                <span>Ваши накопления:</span>
                <span id="savingsAmountText">320 000 ₽</span>
              </div>
            </div>

            <div class="everest-inner">
              <div class="everest-image">
                <div class="goal-star" data-ratio="1">★</div>
                <div class="goal-star" data-ratio="0.8">★</div>
                <div class="goal-star" data-ratio="0.5">★</div>
                <div class="goal-star" data-ratio="0.3">★</div>
                <div class="goal-star" data-ratio="0.05">★</div>
              </div>

              <div class="everest-lines">
                <div class="everest-row" data-ratio="1"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.8"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.5"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.3"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.05"><div class="row-line"></div><div class="row-label amount-label"></div></div>
              </div>
            </div>

            <div class="progress-line" id="progressLine">Прогресс: 32%</div>
          </section>

          <div class="info-block fade-in-up">
            Планируемые поступления на <span id="plannedMonthName">январь</span>:
            <strong id="plannedAmountText">0 ₽</strong>
          </div>

          <!-- ближайшее зачисление (СИНХРОНИЗИРОВАНО С КАЛЕНДАРЕМ) -->
          <div class="info-inline fade-in-up">
            <span id="nextCreditText">Ближайшее зачисление —</span>
            <strong id="nextCreditAmount">—</strong>
          </div>

          <!-- Накопления -->
          <section class="goal-card fade-in-up">
            <div class="goal-row">
              <label for="savingsInput">Накопления</label>
              <div class="goal-input-wrap">
                <input id="savingsInput" class="input" type="text" inputmode="numeric" value="320000" disabled />
                <span>₽</span>
              </div>
              <div class="goal-actions">
                <button class="btn ghost" id="savingsEditBtn">Изменить</button>
                <button class="btn primary hidden" id="savingsApplyBtn">Принять</button>
              </div>
            </div>
            <div class="goal-hint">Фактическая сумма — влияет на звёзды, прогресс, прогноз и “осталось зарплат”.</div>
          </section>

          <!-- Цель -->
          <section class="goal-card fade-in-up">
            <div class="goal-row">
              <label for="goalInput">Цель</label>
              <div class="goal-input-wrap">
                <input id="goalInput" class="input" type="text" inputmode="numeric" value="1000000" disabled />
                <span>₽</span>
              </div>
              <div class="goal-actions">
                <button class="btn ghost" id="goalEditBtn">Изменить</button>
                <button class="btn primary hidden" id="goalApplyBtn">Принять</button>
              </div>
            </div>
            <div class="goal-hint">Сумма цели — влияет на шкалу справа и пороги звёзд.</div>
          </section>

          <!-- Зарплата -->
          <section class="goal-card fade-in-up">
            <div class="goal-row">
              <label for="salaryInput">Размер зарплаты</label>
              <div class="goal-input-wrap">
                <input id="salaryInput" class="input" type="text" inputmode="numeric" value="340000" disabled />
                <span>₽</span>
              </div>
              <div class="goal-actions">
                <button class="btn ghost" id="salaryEditBtn">Изменить</button>
                <button class="btn primary hidden" id="salaryApplyBtn">Принять</button>
              </div>
            </div>
            <div class="goal-hint">Используется для расчёта “осталось X зарплат” и прогноза по месяцам.</div>
          </section>

          <!-- Calendar -->
          <section class="card fade-in-up" id="calendarCard">
            <div class="calendar-top">
              <button class="month-btn" id="monthPrev" aria-label="Предыдущий месяц">‹</button>
              <div class="calendar-header" id="monthTitle">Январь</div>
              <button class="month-btn" id="monthNext" aria-label="Следующий месяц">›</button>
            </div>

            <table class="calendar-grid" aria-label="Календарь" id="calendarTable">
              <thead>
                <tr>
                  <th>П</th><th>В</th><th>С</th><th>Ч</th><th>П</th><th>С</th><th>В</th>
                </tr>
              </thead>
              <tbody id="calendarBody"></tbody>
            </table>

            <div class="calendar-legend">
              <div class="legend-item"><span class="legend-marker salary"></span> Зарплата</div>
              <div class="legend-item"><span class="legend-marker dividends"></span> Дивиденды</div>
              <div class="legend-item"><span class="legend-marker deposit"></span> % по вкладам</div>
              <div class="legend-item"><span class="legend-marker other"></span> Прочее</div>
            </div>
          </section>

          <!-- Chart -->
          <section class="card fade-in-up">
            <div class="chart-title">Изменения баланса</div>
            <div class="chart-wrapper" id="chartWrapper">
              <div class="chart-grid-lines"></div>
              <div class="chart-y-labels">
                <span>100 000</span>
                <span>52 000</span>
                <span>10 000</span>
                <span>1 000</span>
              </div>

              <svg id="line-chart" viewBox="0 0 260 120" role="img">
                <polyline id="balanceLine" class="chart-line" points=""></polyline>
                <g id="balancePoints"></g>
              </svg>

              <div class="chart-x-days" id="chartDays"></div>
              <div class="chart-x-label">Дни</div>
            </div>
          </section>

          <!-- Recommendations -->
          <section class="reco-card fade-in-up">
            <div class="reco-title">Рекомендации по использованию будущих средств:</div>
            <div class="reco-body">
              У вас сейчас стабильный приток средств. Рекомендуем направить часть будущих поступлений
              в накопления — от <strong>10% до 20%</strong>. Также можно увеличить долю инвестиций,
              чтобы ускорить рост капитала. Подумайте о создании финансовой подушки на
              <strong>3–6 месяцев</strong> расходов.
            </div>
          </section>

          <!-- Forecast -->
          <section class="forecast-card fade-in-up" id="forecastCard">
            <div class="forecast-title">Прогноз по месяцам</div>

            <div class="forecast-meta">
              <div class="reach-date" id="reachDateText">Цель будет достигнута: —</div>
              <div class="segmented" role="tablist" aria-label="Режим прогноза">
                <button id="modeSalaryBtn" class="active" type="button">Только зарплата</button>
                <button id="modeAllBtn" type="button">Все поступления</button>
              </div>
            </div>

            <div class="forecast-scroll">
              <table class="forecast-table" aria-label="Прогноз по месяцам">
                <thead>
                  <tr>
                    <th>Месяц</th>
                    <th>Ожидаемые поступления</th>
                    <th>Накопления (прогноз)</th>
                    <th>До цели</th>
                    <th>Статус</th>
                  </tr>
                </thead>
                <tbody id="forecastBody"></tbody>
              </table>
            </div>

            <div class="forecast-note" id="forecastNote">
              Прогноз строится на основе календаря и введённого размера зарплаты.
            </div>
          </section>
        </section>

        <!-- placeholders -->
        
        
        
        
      </div>
    </main>

    <!-- bottom nav -->
    <nav class="navbar">
  <div class="nav-item active" data-tab="home" data-title="Планирование">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/>
      </svg>
    </div>
    <div class="nav-label">Главная</div>
  </div>
  <div class="nav-item" data-tab="payments" data-title="Платежи">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20 7H4V5h16v2zm0 4H4V9h16v2zm0 4H4v-2h16v2zm0 4H4v-2h16v2z"/>
      </svg>
    </div>
    <div class="nav-label">Платежи</div>
  </div>
  <div class="nav-item" data-tab="benefits" data-title="Выгода"><div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6.02 4.02 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 17.98 4 20 6.02 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </div>
    <div class="nav-label">Выгода</div>
  </div>
  <div class="nav-item" data-tab="history" data-title="История"><div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M11 7h2v6h-2V7zm1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-18C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
    </div>
    <div class="nav-label">История</div>
  </div>
  <div class="nav-item" data-tab="chat" data-title="Чаты"><div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 4h16v10H5.17L4 15.17V4zm0-2C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4z"/>
      </svg>
    </div>
    <div class="nav-label">Чаты</div>
  </div>
</nav>

    
  </div>

  <script>
    const backButton = document.getElementById("backButton");
    const topTitle = document.getElementById("topTitle");
    const chartWrapper = document.getElementById("chartWrapper");
    const toast = document.getElementById("toast");
    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const screens = Array.from(document.querySelectorAll(".screen"));
    const appShell = document.getElementById("appShell");

    const everestBannerText = document.getElementById("everestBannerText");
    const goalTitleTop = document.getElementById("goalTitleTop");
    const progressLine = document.getElementById("progressLine");
    const savingsAmountText = document.getElementById("savingsAmountText");

    const plannedMonthName = document.getElementById("plannedMonthName");
    const plannedAmountText = document.getElementById("plannedAmountText");

    const nextCreditText = document.getElementById("nextCreditText");
    const nextCreditAmount = document.getElementById("nextCreditAmount");

    const savingsInput = document.getElementById("savingsInput");
    const savingsEditBtn = document.getElementById("savingsEditBtn");
    const savingsApplyBtn = document.getElementById("savingsApplyBtn");

    const goalInput = document.getElementById("goalInput");
    const goalEditBtn = document.getElementById("goalEditBtn");
    const goalApplyBtn = document.getElementById("goalApplyBtn");

    const salaryInput = document.getElementById("salaryInput");
    const salaryEditBtn = document.getElementById("salaryEditBtn");
    const salaryApplyBtn = document.getElementById("salaryApplyBtn");

    const amountRows = Array.from(document.querySelectorAll(".everest-row"));
    const goalStars = Array.from(document.querySelectorAll(".goal-star"));

    const balanceLine = document.getElementById("balanceLine");
    const balancePointsGroup = document.getElementById("balancePoints");
    const chartDaysContainer = document.getElementById("chartDays");

    // Forecast elements
    const forecastBody = document.getElementById("forecastBody");
    const reachDateText = document.getElementById("reachDateText");
    const modeSalaryBtn = document.getElementById("modeSalaryBtn");
    const modeAllBtn = document.getElementById("modeAllBtn");

    // Calendar elements
    const calendarCard = document.getElementById("calendarCard");
    const monthTitle = document.getElementById("monthTitle");
    const monthPrev = document.getElementById("monthPrev");
    const monthNext = document.getElementById("monthNext");
    const calendarBody = document.getElementById("calendarBody");

    // Chart coords
    const CHART_LEFT = 36;
    const CHART_RIGHT = 244;
    const CHART_BOTTOM = 104;
    const CHART_TOP = 24;

    // State
    let savingsValue = 320000;
    let goalValue = 1000000;
    let salaryValue = 340000;

    let savingsEditing = false;
    let goalEditing = false;
    let salaryEditing = false;

    // Forecast mode: 'salary' or 'all'
    let forecastMode = "salary";

    // Months
    const MONTHS_RU = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const MONTHS_RU_GEN = ["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"];
    let currentMonthIndex = 0;
    const year = new Date().getFullYear();

    // Calendar events by month (0=Jan)
    const eventsByMonth = Array.from({length: 12}, () => ({}));
    eventsByMonth[0] = {
      17: { type: "salary",    amount: 52000 },
      19: { type: "other",     amount: 20000 },
      25: { type: "dividends", amount: 100000 }
    };

    function formatRuble(num) {
      const n = Number(num) || 0;
      return n.toLocaleString("ru-RU") + " ₽";
    }

    function parseNumberFromInput(value) {
      if (!value) return 0;
      const digits = value.toString().replace(/\D/g, "");
      return Number(digits || 0);
    }

    function pluralizeSalary(n) {
      const mod10 = n % 10;
      const mod100 = n % 100;
      if (mod100 >= 11 && mod100 <= 14) return "зарплат";
      if (mod10 === 1) return "зарплата";
      if (mod10 >= 2 && mod10 <= 4) return "зарплаты";
      return "зарплат";
    }

    function updateGoalTitle() {
      goalTitleTop.textContent = `Цель — ${formatRuble(goalValue)}`;
    }

    function updateProgressText() {
      const pct = goalValue > 0 ? Math.min(100, Math.max(0, Math.round((savingsValue / goalValue) * 100))) : 0;
      progressLine.textContent = `Прогресс: ${pct}%`;
    }

    function updateBannerBySalary() {
      const remaining = Math.max(goalValue - savingsValue, 0);
      const denom = Math.max(salaryValue, 1);
      const left = remaining === 0 ? 0 : Math.ceil(remaining / denom);
      const word = pluralizeSalary(left);
      everestBannerText.textContent = left === 0
        ? "Цель достигнута! Отличная работа!"
        : `До новой машины осталось всего ${left} ${word}! Так держать!`;
    }

    function applyStarsSequential() {
      goalStars.forEach((s) => s.classList.remove("delay-0","delay-1","delay-2","delay-3","delay-4"));
      const ordered = [...goalStars].sort((a,b)=>parseFloat(b.dataset.ratio)-parseFloat(a.dataset.ratio));
      ordered.forEach((star, idx) => {
        if (star.classList.contains("on")) star.classList.add(`delay-${Math.min(idx,4)}`);
      });
    }

    function recalcGoalUI() {
      amountRows.forEach((row) => {
        const ratio = parseFloat(row.dataset.ratio);
        const label = row.querySelector(".amount-label");
        if (!label || !ratio) return;
        const threshold = Math.round(goalValue * ratio);
        label.textContent = threshold ? formatRuble(threshold) : "0 ₽";
        row.dataset.threshold = threshold;
      });

      goalStars.forEach((star) => {
        const ratio = parseFloat(star.dataset.ratio);
        const threshold = Math.round(goalValue * ratio);
        const on = savingsValue >= threshold && threshold > 0;
        star.classList.toggle("on", on);
      });

      applyStarsSequential();
      updateProgressText();
      updateBannerBySalary();
      updateForecast();
      updateNextCredit();
      updatePlannedIncomesLabel();
    }

    function setEditing(input, editBtn, applyBtn, on) {
      input.disabled = !on;
      input.classList.toggle("editing", on);
      editBtn.classList.toggle("hidden", on);
      applyBtn.classList.toggle("hidden", !on);
      if (on) input.focus();
    }

    // Savings controls
    savingsEditBtn.addEventListener("click", () => {
      savingsEditing = true;
      savingsInput.value = String(savingsValue);
      setEditing(savingsInput, savingsEditBtn, savingsApplyBtn, true);
      showToast("Введите сумму накоплений и нажмите «Принять»");
    });
    savingsInput.addEventListener("input", () => {
      if (!savingsEditing) return;
      const v = parseNumberFromInput(savingsInput.value);
      savingsInput.value = v ? v.toLocaleString("ru-RU") : "";
    });
    savingsApplyBtn.addEventListener("click", () => {
      const v = parseNumberFromInput(savingsInput.value);
      savingsValue = Math.max(0, v);
      savingsInput.value = savingsValue.toLocaleString("ru-RU");
      savingsAmountText.textContent = formatRuble(savingsValue);
      savingsEditing = false;
      setEditing(savingsInput, savingsEditBtn, savingsApplyBtn, false);
      recalcGoalUI();
      showToast("Прогресс обновлён");
    });

    // Goal controls
    goalEditBtn.addEventListener("click", () => {
      goalEditing = true;
      goalInput.value = String(goalValue);
      setEditing(goalInput, goalEditBtn, goalApplyBtn, true);
      showToast("Введите новую цель и нажмите «Принять»");
    });
    goalInput.addEventListener("input", () => {
      if (!goalEditing) return;
      const v = parseNumberFromInput(goalInput.value);
      goalInput.value = v ? v.toLocaleString("ru-RU") : "";
    });
    goalApplyBtn.addEventListener("click", () => {
      const v = parseNumberFromInput(goalInput.value);
      if (v <= 0) { showToast("Цель должна быть больше 0"); return; }
      goalValue = v;
      goalInput.value = goalValue.toLocaleString("ru-RU");
      goalEditing = false;
      setEditing(goalInput, goalEditBtn, goalApplyBtn, false);
      updateGoalTitle();
      recalcGoalUI();
      showToast("Цель сохранена");
    });

    // Salary controls
    salaryEditBtn.addEventListener("click", () => {
      salaryEditing = true;
      salaryInput.value = String(salaryValue);
      setEditing(salaryInput, salaryEditBtn, salaryApplyBtn, true);
      showToast("Введите размер зарплаты и нажмите «Принять»");
    });
    salaryInput.addEventListener("input", () => {
      if (!salaryEditing) return;
      const v = parseNumberFromInput(salaryInput.value);
      salaryInput.value = v ? v.toLocaleString("ru-RU") : "";
    });
    salaryApplyBtn.addEventListener("click", () => {
      const v = parseNumberFromInput(salaryInput.value);
      if (v <= 0) { showToast("Зарплата должна быть больше 0"); return; }
      salaryValue = v;
      salaryInput.value = salaryValue.toLocaleString("ru-RU");
      salaryEditing = false;
      setEditing(salaryInput, salaryEditBtn, salaryApplyBtn, false);
      recalcGoalUI();
      showToast("Размер зарплаты сохранён");
    });

    // ===== Calendar =====
    function daysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }
    function firstDayMondayIndex(y, m) {
      const d = new Date(y, m, 1);
      const js = d.getDay(); // Sun=0..Sat=6
      return (js + 6) % 7;   // Mon=0..Sun=6
    }

    function renderCalendar(monthIndex) {
      monthTitle.textContent = MONTHS_RU[monthIndex];

      const totalDays = daysInMonth(year, monthIndex);
      const offset = firstDayMondayIndex(year, monthIndex);

      const monthEvents = eventsByMonth[monthIndex] || {};
      calendarBody.innerHTML = "";

      let day = 1;
      for (let week = 0; week < 6; week++) {
        const tr = document.createElement("tr");

        for (let dow = 0; dow < 7; dow++) {
          const td = document.createElement("td");

          const cellIndex = week * 7 + dow;
          if (cellIndex < offset || day > totalDays) {
            td.innerHTML = "";
          } else {
            const btn = document.createElement("button");
            btn.className = "day";
            btn.textContent = day;

            const ev = monthEvents[day];
            if (ev) {
              btn.dataset.type = ev.type;
              btn.dataset.amount = String(ev.amount);
              const dot = document.createElement("span");
              dot.className = `dot ${ev.type}`;
              btn.appendChild(dot);
            }

            btn.addEventListener("click", () => {
              calendarBody.querySelectorAll(".day").forEach(b => b.classList.remove("selected"));
              btn.classList.add("selected");
              if (btn.dataset.type) {
                const t = btn.dataset.type;
                let text = "";
                if (t === "salary") text = "Зачисление зарплаты";
                if (t === "dividends") text = "Выплата дивидендов";
                if (t === "other") text = "Прочее поступление средств";
                if (text) showToast(text);
              }
            });

            td.appendChild(btn);
            day++;
          }

          tr.appendChild(td);
        }

        calendarBody.appendChild(tr);
        if (day > totalDays) break;
      }

      buildChartFromRenderedCalendar();
      chartWrapper.classList.remove("loaded");
      setTimeout(() => chartWrapper.classList.add("loaded"), 80);

      updatePlannedIncomesLabel();
      updateNextCredit();
      updateForecast();
    }

    function changeMonth(delta) {
      currentMonthIndex = Math.max(0, Math.min(11, currentMonthIndex + delta));
      renderCalendar(currentMonthIndex);
    }

    monthPrev.addEventListener("click", () => changeMonth(-1));
    monthNext.addEventListener("click", () => changeMonth(+1));

    // swipe calendar months
    let calStartX = null, calStartY = null;
    calendarCard.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      calStartX = t.clientX; calStartY = t.clientY;
    }, {passive:true});

    calendarCard.addEventListener("touchend", (e) => {
      if (calStartX == null || calStartY == null) return;
      const t = e.changedTouches[0];
      const dx = t.clientX - calStartX;
      const dy = t.clientY - calStartY;
      calStartX = calStartY = null;

      if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy)) return;
      if (dx < 0) changeMonth(+1);
      else changeMonth(-1);
    }, {passive:true});

    // ===== Chart =====
    
function buildChartFromRenderedCalendar() {
  // События берём из календаря (data-amount / data-type), чтобы цветные точки
  // строго соответствовали событиям и дням.
  const dayButtons = Array.from(document.querySelectorAll("#calendarBody .day[data-amount]"));

  // Собираем события текущего месяца: {day, amount, type}
  const events = [];
  dayButtons.forEach((btn) => {
    const dayText = (btn.childNodes[0] && btn.childNodes[0].nodeType === 3)
      ? btn.childNodes[0].textContent
      : btn.textContent;
    const day = Number(String(dayText).trim());
    const amount = Number(btn.dataset.amount || 0);
    const type = btn.dataset.type || "other";
    if (!day) return;
    events.push({ day, amount, type });
  });

  const totalDays = daysInMonth(year, currentMonthIndex);

  // Если событий нет — баланс ровной линией (параллельно оси X)
  if (!events.length) {
    const width = CHART_RIGHT - CHART_LEFT;
    const height = CHART_BOTTOM - CHART_TOP;

    // рисуем горизонталь по середине с привязкой к savingsValue (чтобы не прыгало)
    const values = [savingsValue];
    let vmin = Math.min(...values), vmax = Math.max(...values);
    if (vmin === vmax) { vmin -= 1; vmax += 1; }

    const yForValue = (v) => {
      const ratio = (v - vmin) / (vmax - vmin);
      return CHART_BOTTOM - ratio * height;
    };

    const y = yForValue(savingsValue);
    const pts = [
      `${CHART_LEFT.toFixed(1)},${y.toFixed(1)}`,
      `${CHART_RIGHT.toFixed(1)},${y.toFixed(1)}`
    ].join(" ");

    balanceLine.setAttribute("points", pts);
    balancePointsGroup.innerHTML = "";
    chartDaysContainer.innerHTML = "";
    return;
  }

  // Сортируем события по дням
  events.sort((a, b) => a.day - b.day);

  const width = CHART_RIGHT - CHART_LEFT;
  const height = CHART_BOTTOM - CHART_TOP;

  // Шкала X: по дням месяца (1..totalDays)
  const xForDay = (day) => {
    if (totalDays <= 1) return CHART_LEFT;
    const t = (day - 1) / (totalDays - 1);
    return CHART_LEFT + t * width;
  };

  // Рассчитываем накопленный баланс по дням (сумма денег к конкретному дню)
  let cumulative = savingsValue;

  // Для "ступенчатой" линии: горизонтально между событиями, вертикально в день события.
  const polyPoints = [];
  const pointDots = [];

  // Начало месяца
  polyPoints.push({ day: 1, value: cumulative });

  events.forEach((e) => {
    const day = Math.max(1, Math.min(totalDays, e.day));

    // До события — горизонталь до дня события (с текущим балансом)
    polyPoints.push({ day, value: cumulative });

    // После события — вертикальный скачок в тот же день
    cumulative = cumulative + (Number(e.amount) || 0);
    polyPoints.push({ day, value: cumulative });

    // Цветная точка события ставится на желтой линии (после начисления)
    pointDots.push({ day, value: cumulative, type: e.type });
  });

  // Конец месяца — горизонталь до последнего дня
  polyPoints.push({ day: totalDays, value: cumulative });

  // Y-шкала — по накопленному балансу (а не по суммам событий)
  const allValues = polyPoints.map(p => p.value);
  let vmin = Math.min(...allValues);
  let vmax = Math.max(...allValues);
  if (vmin === vmax) { vmin -= 1; vmax += 1; }

  // Обновляем подписи оси Y реальными значениями накопленного баланса
  // (чтобы цифры слева совпадали с фактическими значениями по событиям).
  const yLabelsBox = document.querySelector(".chart-y-labels");
  if (yLabelsBox) {
    // важные значения: старт, после каждого события, финал
    const important = [savingsValue, ...pointDots.map(p => p.value), cumulative]
      .map(v => Math.round(v))
      .filter(v => Number.isFinite(v));
    const uniq = [...new Set(important)].sort((a,b)=>a-b);

    // хотим максимум 4 подписи как в макете
    let ticks = uniq;
    if (ticks.length > 4) {
      const idxs = [0, Math.round((ticks.length-1)/3), Math.round((ticks.length-1)*2/3), ticks.length-1];
      ticks = idxs.map(i => ticks[i]);
      ticks = [...new Set(ticks)].sort((a,b)=>a-b);
      // если после дедупликации стало меньше 4 — добиваем ближайшими значениями
      while (ticks.length < 4 && uniq.length > ticks.length) {
        const candidate = uniq.find(v => !ticks.includes(v));
        if (candidate == null) break;
        ticks.push(candidate);
        ticks.sort((a,b)=>a-b);
      }
      // если всё равно >4 (редко) — срежем
      if (ticks.length > 4) ticks = ticks.slice(0,4);
    }

    // перерисовываем 4 строки
    yLabelsBox.innerHTML = "";
    const ticksDesc = [...ticks].sort((a,b)=>b-a);
    ticksDesc.forEach(v => {
      const s = document.createElement("span");
      s.textContent = v.toLocaleString("ru-RU");
      yLabelsBox.appendChild(s);
    });
    // если меньше 4 — добиваем пустыми (чтобы высота была стабильной)
    while (yLabelsBox.children.length < 4) {
      const s = document.createElement("span");
      s.textContent = "";
      yLabelsBox.appendChild(s);
    }
  }

  const yForValue = (v) => {
    const ratio = (v - vmin) / (vmax - vmin);
    return CHART_BOTTOM - ratio * height;
  };

  // Полилиния
  const linePoints = polyPoints
    .map(p => `${xForDay(p.day).toFixed(1)},${yForValue(p.value).toFixed(1)}`)
    .join(" ");
  balanceLine.setAttribute("points", linePoints);

  // Точки событий
  balancePointsGroup.innerHTML = "";
  const svgNS = "http://www.w3.org/2000/svg";
  pointDots.forEach((p) => {
    const c = document.createElementNS(svgNS, "circle");
    c.setAttribute("cx", xForDay(p.day).toFixed(1));
    c.setAttribute("cy", yForValue(p.value).toFixed(1));
    c.setAttribute("r", "4");
    c.setAttribute("class", `chart-point ${p.type}`);
    balancePointsGroup.appendChild(c);
  });

  // Подписи по оси X — только дни, когда есть начисления (события)
  chartDaysContainer.innerHTML = "";
  const uniqueDays = [...new Set(events.map(e => e.day))].sort((a,b)=>a-b);
  uniqueDays.forEach((day) => {
    const span = document.createElement("span");
    span.textContent = day;
    const leftPct = totalDays <= 1 ? 0 : ((day - 1) / (totalDays - 1)) * 100;
    span.style.left = leftPct + "%";
    chartDaysContainer.appendChild(span);
  });
}

    // ===== Planned inflows label =====

    function monthIncome(monthIdx, mode) {
      const ev = eventsByMonth[monthIdx] || {};
      // Зарплата в прогнозе считаем как стабильную: 1 раз в месяц (salaryValue),
      // даже если в календаре нет события "salary" в этом месяце.
      let otherSum = 0;

      Object.keys(ev).forEach((day) => {
        const e = ev[day];
        if (!e) return;
        if (e.type !== "salary") otherSum += Number(e.amount || 0);
      });

      const salarySum = salaryValue; // 1 зарплата в месяц
      const total = (mode === "salary") ? salarySum : (salarySum + otherSum);

      return { otherSum, salarySum, total };
    }

    function updatePlannedIncomesLabel(){
      plannedMonthName.textContent = MONTHS_RU_GEN[currentMonthIndex];
      const inc = monthIncome(currentMonthIndex, forecastMode);
      plannedAmountText.textContent = formatRuble(inc.total);
    }

    // ===== Next credit line (NEW) =====
    function updateNextCredit() {
      const ev = eventsByMonth[currentMonthIndex] || {};
      const days = Object.keys(ev).map(d => Number(d)).sort((a,b)=>a-b);

      if (!days.length) {
        nextCreditText.textContent = "Ближайшее зачисление — нет запланированных";
        nextCreditAmount.textContent = "—";
        return;
      }

      const now = new Date();
      const todayMonth = now.getMonth();
      const todayDay = now.getDate();

      let nextDay = null;
      for (const d of days) {
        if (currentMonthIndex === todayMonth) {
          if (d >= todayDay) { nextDay = d; break; }
        } else {
          nextDay = d; break;
        }
      }
      // если месяц текущий и все события уже прошли — показываем первое событие (как “следующее в этом месяце” не найти)
      if (nextDay === null) nextDay = days[0];

      const event = ev[nextDay];
      const isSalary = event.type === "salary";
      const amount = isSalary ? salaryValue : Number(event.amount || 0);

      nextCreditText.textContent = `Ближайшее зачисление ${nextDay} ${MONTHS_RU_GEN[currentMonthIndex]}`;
      nextCreditAmount.textContent = formatRuble(amount);
    }

    // ===== Forecast (UPGRADED) =====
    function formatReachDate(monthIdx){
      const lastDay = new Date(year, monthIdx + 1, 0).getDate();
      return `${lastDay} ${MONTHS_RU_GEN[monthIdx]} ${year}`;
    }

    function updateForecast() {
      if (!forecastBody) return;

      forecastBody.innerHTML = "";

      let proj = savingsValue;
      let goalReachedMonth = -1;

      for (let m = currentMonthIndex; m < 12; m++) {
        const inc = monthIncome(m, forecastMode);
        proj = proj + inc.total;

        if (goalReachedMonth === -1 && proj >= goalValue) goalReachedMonth = m;
      }

      // reach date label
      if (goalReachedMonth === -1) {
        reachDateText.textContent = "Цель в этом году не будет достигнута (по текущему прогнозу)";
      } else {
        reachDateText.textContent = `Цель будет достигнута: ${formatReachDate(goalReachedMonth)}`;
      }

      // render rows (again, for correct per-row projection)
      proj = savingsValue;
      for (let m = currentMonthIndex; m < 12; m++) {
        const inc = monthIncome(m, forecastMode);
        proj = proj + inc.total;

        const remaining = Math.max(goalValue - proj, 0);

        const tr = document.createElement("tr");
        if (m === goalReachedMonth) tr.classList.add("forecast-row-goal");

        const tdMonth = document.createElement("td");
        tdMonth.textContent = MONTHS_RU[m];

        const tdInc = document.createElement("td");
        tdInc.textContent = formatRuble(inc.total);

        const tdProj = document.createElement("td");
        tdProj.textContent = formatRuble(proj);

        const tdRem = document.createElement("td");
        tdRem.textContent = remaining === 0 ? "0 ₽" : formatRuble(remaining);

        const tdStatus = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "forecast-badge " + (proj >= goalValue ? "badge-goal" : "badge-ok");
        badge.textContent = (proj >= goalValue)
          ? (m === goalReachedMonth ? "Месяц достижения" : "Цель достигнута")
          : "В процессе";
        tdStatus.appendChild(badge);

        tr.appendChild(tdMonth);
        tr.appendChild(tdInc);
        tr.appendChild(tdProj);
        tr.appendChild(tdRem);
        tr.appendChild(tdStatus);

        forecastBody.appendChild(tr);
      }
    }

    // Forecast mode toggles
    function setForecastMode(mode){
      forecastMode = mode;
      modeSalaryBtn.classList.toggle("active", mode === "salary");
      modeAllBtn.classList.toggle("active", mode === "all");
      updatePlannedIncomesLabel();
      updateForecast();
    }
    modeSalaryBtn.addEventListener("click", () => setForecastMode("salary"));
    modeAllBtn.addEventListener("click", () => setForecastMode("all"));

    // ===== Tabs / Swipe =====
    function setActiveTab(tab) {
      navItems.forEach((item) => item.classList.toggle("active", item.dataset.tab === tab));
      screens.forEach((screen) => screen.classList.toggle("active", screen.dataset.tab === tab));
      const activeNav = navItems.find((i) => i.dataset.tab === tab);
      if (activeNav && activeNav.dataset.title) topTitle.textContent = activeNav.dataset.title;
    }
        // нижняя панель не кликабельна (прототип)

    // свайп между вкладками отключён

    // ===== Toast =====
    let toastTimeout;
    function showToast(message, duration = 2100) {
      toast.textContent = message;
      toast.classList.add("visible");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.classList.remove("visible"), duration);
    }

    // Back
    backButton.addEventListener("click", () => {
      window.location.href = "index.html";
    });

// Init
    window.addEventListener("DOMContentLoaded", () => {
savingsInput.value = savingsValue.toLocaleString("ru-RU");
      goalInput.value = goalValue.toLocaleString("ru-RU");
      salaryInput.value = salaryValue.toLocaleString("ru-RU");

      savingsAmountText.textContent = formatRuble(savingsValue);

      updateGoalTitle();
      recalcGoalUI();

      renderCalendar(currentMonthIndex);

      setTimeout(() => chartWrapper.classList.add("loaded"), 700);
      
    });
  
// === Y-AXIS FIX: labels match salary & event amounts ===
function updateYAxisFromBalances(balances) {
  const yAxis = document.querySelector('.chart-y-axis');
  if (!yAxis) return;

  yAxis.innerHTML = '';

  if (!balances || balances.length === 0) {
    const zero = document.createElement('div');
    zero.textContent = '0 ₽';
    yAxis.appendChild(zero);
    return;
  }

  const uniq = Array.from(new Set(balances)).sort((a,b)=>a-b);

  uniq.forEach(v => {
    const t = document.createElement('div');
    t.textContent = v.toLocaleString('ru-RU') + ' ₽';
    yAxis.appendChild(t);
  });
}

</script>
</body>
</html>
