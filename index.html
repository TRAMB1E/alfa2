<!DOCTYPE html>
<html lang="ru">
<head>
<meta charset="UTF-8">
<title>Финздоровье</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- Roboto -->
<link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">

<style>
/* ===== БАЗА ===== */
body {
  margin: 0;
  background: #F3F4F5;
  font-family: 'Roboto', system-ui, -apple-system, sans-serif;
  color: #000000;
  font-size: 17px; /* базовый текст */
}
/* стрелка раскрытия — как в примере */
/* аккуратная стрелка */
.tasks-arrow {
  position: absolute;
  left: 50%;
  bottom: -10px;
  transform: translateX(-50%);
  width: 18px;
  height: 18px;
  pointer-events: auto;
cursor: pointer;
  z-index: 2;
  opacity: 0.75;
}
.tasks-arrow svg {
  width: 100%;
  height: 100%;
  fill: none;
  stroke: #7F7F83;
  stroke-width: 2.5;
  stroke-linecap: round;
  stroke-linejoin: round;
  transition: transform 0.2s ease;
  transform-origin: 50% 50%;
}

/* при раскрытии — поворот вверх */
.tasks-card.expanded .tasks-arrow svg {
  transform: rotate(180deg);
}


.app {
  max-width: 390px;
  margin: auto;
  background: #F3F4F5;
  min-height: 100vh;
  padding: 16px 16px 90px;  /* 16 по бокам, отступ под навбар */
  box-sizing: border-box;
}

/* Заголовок */
h1 {
  font-size: 22px;      /* по ТЗ */
  font-weight: 700;     /* Bold */
  line-height: 1.3;
  margin: 0 0 16px;     /* вертикальный шаг 16 */
}
h1 span {
  color: #ff3b00;
}

/* ===== КРУГОВЫЕ ДИАГРАММЫ (SVG) ===== */
.charts-card {
  background: #FFFFFF;
  border-radius: 24px;
  padding: 16px;
  display: flex;
  justify-content: space-around;
  align-items: center;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.04);
  margin-bottom: 16px; /* расстояние между блоками */
}

.chart-box {
  text-align: center;
}

.donut {
  width: 140px;
  height: 140px;
}

.donut svg {
  width: 100%;
  height: 100%;
}

.chart-label {
  margin-top: 6px;
  font-size: 15px;
  font-weight: 500;
}

/* Цвета сегментов — ДОХОДЫ */
.income-arc-1 { fill: #FACC15; }
.income-arc-2 { fill: #A3E635; }
.income-arc-3 { fill: #22D3EE; }
.income-arc-4 { fill: #2563EB; }
.income-arc-5 { fill: #A855F7; }
.income-arc-6 { fill: #F472B6; }

/* Цвета сегментов — РАСХОДЫ */
.expense-arc-1 { fill: #A3E635; }
.expense-arc-2 { fill: #2563EB; }
.expense-arc-3 { fill: #22D3EE; }
.expense-arc-4 { fill: #8B5CF6; }
.expense-arc-5 { fill: #F472B6; }
.expense-arc-6 { fill: #FACC15; }

/* ===== ЗДОРОВЬЕ ===== */
.health {
  margin-top: 16px;
}

.health-label {
  font-size: 15px;
  font-weight: 500;
  margin-bottom: 6px;
}

.health-bar {
  height: 12px;
  background: #a3e635;
  border-radius: 6px;
  position: relative;
  overflow: visible;
}

.health-fill {
  width: 100%;
  height: 100%;
}

.health-heart {
  position: absolute;
  right: -8px;
  top: 50%;
  transform: translate(0, -50%);
}

.health-heart svg {
  width: 16px;
  height: 16px;
  fill: #ff3b00;
  stroke: #000000;
  stroke-width: 1.5px;
}

.health-value {
  font-size: 13px;
  margin-top: 4px;
  text-align: right;
  color: #7F7F83;
}

/* ===== ЗАДАНИЯ (СЛАЙДЕР + РАСКРЫТИЕ) ===== */
.tasks-card {
  margin-top: 16px;
  background: #FFFFFF;
  border-radius: 24px;
  border: 1px solid #F3F4F5;
  overflow: hidden;              /* важно, чтобы хвостик был виден */
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.04);
  position: relative;             /* якорь для хвостика */
}
.tasks-wrap {
  position: relative;
  margin-top: 16px;     /* перенесли отступ сюда */
}
.tasks-wrap.expanded .tasks-arrow svg {
  transform: rotate(180deg);
}

.tasks-tail {
  position: absolute;
  left: 50%;
  bottom: -10px;        /* насколько торчит вниз */
  transform: translateX(-50%);
  width: 34px;
  height: 22px;
  background: #fff;
  border: 1px solid #F3F4F5;
  border-top: none;
  border-radius: 0 0 18px 18px;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.04);
  pointer-events: none;
}
.tasks-card::after {
  content: "";
  position: absolute;
  left: 50%;
  bottom: -10px;                  /* насколько хвостик торчит вниз */
  transform: translateX(-50%);

  width: 28px;                    /* ширина хвостика */
  height: 18px;                   /* высота хвостика */

  background: #FFFFFF;
  border: 1px solid #F3F4F5;
  border-top: none;               /* чтобы не было двойной линии сверху */

  border-bottom-left-radius: 14px;
  border-bottom-right-radius: 14px;
  border-top-left-radius: 14px;
  border-top-right-radius: 14px;

  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.04); /* совпадает с карточкой */
}

/* контейнер со слайдами */
.tasks-slider {
  display: flex;
  width: 300%;              /* три страницы */
  transition: 0.3s;
}

/* страница */
.task-page {
  width: 33.3333%;
  padding: 16px;
  box-sizing: border-box;
  cursor: pointer;
}

.task-page h3 {
  margin-bottom: 12px;
  font-size: 18px;
  font-weight: 700;
  text-align: center;
}

/* краткий / подробный списки */
.tasks-short,
.tasks-full {
  margin-top: 4px;
}

.tasks-full {
  display: none;
}

.tasks-card.expanded .tasks-short {
  display: none;
}

.tasks-card.expanded .tasks-full {
  display: block;
}

.task {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-top: 8px;
  font-size: 15px;
}

.task-prefix {
  font-weight: 700;
}

.task-link {
  color: #ff3b00;
}

/* чекбоксы */
.check {
  flex: 0 0 20px;
  min-width: 20px;
  width: 20px;
  height: 20px;
  border-radius: 4px;
  border: 2px solid #000000;
  box-sizing: border-box;
  position: relative;
}

/* галочка внутри квадрата */
.check.active::after {
  content: "";
  position: absolute;
  width: 8px;
  height: 12px;
  border-right: 2px solid #ff3b00;
  border-bottom: 2px solid #ff3b00;
  transform: rotate(45deg);
  left: 3px;
  top: 0px;
}

/* точки (для слайдера заданий) */
.dots {
  display: flex;
  justify-content: center;
  padding-bottom: 26px;
  padding: 8px 0 18px; /* было 8px 0 10px */
}

.dot {
  width: 6px;
  height: 6px;
  background: #D0D1D3;
  border-radius: 50%;
  margin: 0 4px;
}

.dot.active {
  background: #000000;
}

/* ===== ФИНАНСОВЫЕ РАЗДЕЛЫ ===== */
.finance-title {
  margin-top: 16px;
  font-weight: 700;
  font-size: 20px;
}

/* основная карточка */
.finance-main {
  background: linear-gradient(135deg, #ff5a1f, #ff8a00);
  height: 120px;
  border-radius: 24px;
  margin-top: 16px;
  color: #FFFFFF;
  padding: 16px;
  font-weight: 600;
  display: flex;
  align-items: flex-start;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.08);
}

.finance-text {
  font-size: 17px;
  line-height: 1.2;
  max-width: 70%;
}

/* иллюстрации */
.finance-illustration {
  position: absolute;
  right: -4px;
  bottom: -6px;
  height: 80%;
  pointer-events: none;
}

.finance-illustration-main {
  right: -8px;
  bottom: -8px;
  height: 110%;
}

.finance-grid {
  display: grid;
  grid-template-columns: 1fr 1fr;
  gap: 16px;
  margin-top: 16px;
}

.finance-card {
  height: 110px;
  border-radius: 24px;
  color: #FFFFFF;
  padding: 14px;
  font-weight: 600;
  display: flex;
  align-items: flex-start;
  font-size: 17px;
  position: relative;
  overflow: hidden;
  cursor: pointer;
  box-shadow: 0 8px 18px rgba(0, 0, 0, 0.06);
}

.finance-link {
  text-decoration: none;
}

.blue {
  background: linear-gradient(135deg, #6366f1, #3b82f6);
}

.green {
  background: linear-gradient(135deg, #22c55e, #16a34a);
}

/* ===== НИЖНЕЕ МЕНЮ ===== */
.navbar {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  max-width: 390px;
  margin: auto;
  background: #FFFFFF;
  height: 60px;
  border-top: 1px solid #F3F4F5;
  display: flex;
  justify-content: space-around;
  align-items: center;
}

.nav-item {
  font-size: 10px;
  text-align: center;
  color: #7F7F83; /* неактивный по ТЗ */
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 2px;
}

.nav-item.active {
  color: #000000;
  font-weight: 700;
}

.nav-icon {
  width: 18px;
  height: 18px;
}

.nav-icon svg {
  width: 100%;
  height: 100%;
  fill: currentColor;
}

/* ===== МОДАЛЬНОЕ ОКНО КАЛЕНДАРЯ (оставил твой дизайн) ===== */

.calendar-overlay {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
}

.calendar-overlay.active {
  display: flex;
}

.cal-app {
  width: 360px;
  max-width: 100%;
  padding: 24px 16px;
  border-radius: 24px;
  background: #222;
  box-shadow: 0 18px 40px rgba(0, 0, 0, 0.6);
  display: flex;
  flex-direction: column;
  align-items: center;
  animation: cal-app-pop 450ms ease-out;
}

@keyframes cal-app-pop {
  from {
    transform: translateY(18px) scale(0.96);
    opacity: 0;
  }
  to {
    transform: translateY(0) scale(1);
    opacity: 1;
  }
}

.cal-header {
  width: 100%;
  display: flex;
  align-items: center;
  margin-bottom: 18px;
  color: #e0e0e0;
  font-size: 11px;
  opacity: 0.7;
}

.cal-back {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  border: none;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  margin-right: 6px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
}

.cal-back svg {
  width: 16px;
  height: 16px;
  stroke: #f5f5f5;
  stroke-width: 2.2;
  fill: none;
}

.cal-title {
  flex: 1;
  text-align: center;
  font-size: 10px;
  text-transform: lowercase;
  letter-spacing: 0.04em;
}

/* Карточка внутри модалки */
.cal-card {
  width: 100%;
  border-radius: 20px;
  background: #ebebee;
  padding: 18px 14px 14px;
  display: flex;
  flex-direction: column;
  gap: 10px;
}

/* Month header */

.cal-month-header {
  display: flex;
  justify-content: center;
  align-items: center;
  margin-bottom: 6px;
  gap: 10px;
}

.cal-month-title {
  font-size: 20px;
  font-weight: 700;
  letter-spacing: 0.04em;
  color: #3a3a3a;
}

.cal-month-nav {
  width: 26px;
  height: 26px;
  border-radius: 50%;
  border: none;
  background: transparent;
  display: flex;
  align-items: center;
  justify-content: center;
  cursor: pointer;
  transition: background-color 120ms ease, transform 120ms ease;
}

.cal-month-nav svg {
  width: 14px;
  height: 14px;
  stroke: #777;
  stroke-width: 2;
  fill: none;
}

.cal-month-nav:hover {
  background: rgba(0, 0, 0, 0.04);
}

.cal-month-nav:active {
  transform: scale(0.94);
}

/* Calendar */

.cal-calendar {
  position: relative;
  padding: 0 4px 10px;
  border-radius: 16px;
  background: #fdfdfd;
}

.cal-weekdays {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  text-align: center;
  font-size: 12px;
  font-weight: 600;
  background: #e53935;
  color: #fff;
  border-radius: 12px;
  padding: 8px 0;
  text-transform: uppercase;
  letter-spacing: 0.08em;
  margin-bottom: 10px;
}

.cal-days {
  display: grid;
  grid-template-columns: repeat(7, 1fr);
  row-gap: 16px;
  column-gap: 4px;
  font-size: 13px;
  padding: 4px 4px 2px;
}

.cal-day {
  border: none;
  background: transparent;
  display: flex;
  flex-direction: column;
  align-items: center;
  cursor: pointer;
  position: relative;
  height: 34px;
  color: #565656;
  transition: transform 120ms ease, color 120ms ease;
}

.cal-day.disabled {
  opacity: 0;
  pointer-events: none;
}

.cal-day-number {
  font-size: 14px;
  margin-bottom: 4px;
  width: 26px;
  height: 26px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: background 0.15s ease, color 0.15s ease, box-shadow 0.15s ease;
}

.cal-day:hover {
  transform: translateY(-1px);
  color: #111;
}

.cal-day.selected .cal-day-number {
  background: #e53935;
  color: #ffffff;
  font-weight: 700;
  box-shadow: 0 4px 8px rgba(229, 57, 53, 0.35);
}

.cal-day-events {
  display: flex;
  gap: 4px;
  justify-content: center;
  max-width: 26px;         /* не даём точкам растягиваться в линию */
  flex-wrap: wrap;         /* если точек много — переносим */
  overflow: hidden;        /* на всякий случай клипуем */
}

.cal-more {
  font-size: 10px;
  font-weight: 700;
  line-height: 1;
  color: #565656;
  margin-top: -1px;
}

.cal-dot {
  width: 7px;
  height: 7px;
  border-radius: 50%;
}

.cal-dot.salary   { background: #0ea768; }
.cal-dot.okko     { background: #e91e63; }
.cal-dot.credit   { background: #ff9800; }
.cal-dot.rent     { background: #fdd835; }

/* Legend */

.cal-legend {
  margin-top: 12px;
  background: #ffffff;
  border-radius: 16px;
  padding: 10px 10px 8px;
  font-size: 11px;
  display: grid;
  grid-template-columns: repeat(2, minmax(0, 1fr));
  gap: 6px 10px;
}

.cal-legend-item {
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
}

.cal-legend-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
}

.cal-legend-dot.salary   { background: #0ea768; }
.cal-legend-dot.okko     { background: #e91e63; }
.cal-legend-dot.credit   { background: #ff9800; }
.cal-legend-dot.rent     { background: #fdd835; }

.cal-selected-info {
  font-size: 11px;
  margin-top: 6px;
  min-height: 16px;
  color: #4b5563;
  transition: opacity 160ms ease;
}

.cal-selected-info span {
  font-weight: 600;
}

/* список событий в выбранный день */
.cal-event-list{
  margin-top: 6px;
  display: flex;
  flex-direction: column;
  gap: 8px;
}
.cal-event-row{
  display: grid;
  grid-template-columns: 12px 1fr auto;
  gap: 8px;
  align-items: center;
  background: rgba(0,0,0,0.03);
  border-radius: 12px;
  padding: 8px 10px;
}
.cal-event-dot{
  width: 10px;
  height: 10px;
  border-radius: 50%;
}
.cal-event-title{
  font-size: 12px;
  color: #374151;
  line-height: 1.2;
}
.cal-event-del{
  border: none;
  background: transparent;
  color: #e53935;
  font-weight: 700;
  font-size: 11px;
  cursor: pointer;
  padding: 6px 8px;
  border-radius: 10px;
}
.cal-event-del:active{
  transform: translateY(1px);
  opacity: 0.85;
}

/* Button */

.cal-add-section {
  margin-top: 10px;
  background: #ffffff;
  border-radius: 16px;
  padding: 8px 10px;
  display: flex;
  justify-content: center;
}

.cal-add-btn {
  border: none;
  background: transparent;
  color: #e53935;
  font-weight: 600;
  font-size: 13px;
  cursor: pointer;
  position: relative;
  overflow: hidden;
  padding: 8px 14px;
  border-radius: 999px;
}

.cal-add-btn:active {
  transform: translateY(1px);
}

@media (max-width: 420px) {
  .cal-app {
    width: 100%;
    border-radius: 0;
  }
  .cal-card {
    margin-top: 6px;
  }
}
/* ===== МОДАЛЬНОЕ ОКНО ДОБАВЛЕНИЯ СОБЫТИЯ ===== */
.event-overlay{
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.55);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1100; /* выше календаря */
}
.event-overlay.active{ display:flex; }

.event-app{
  width: 360px;
  max-width: 100%;
  /* фиксируем “каркас” модалки, чтобы контент внутри мог скроллиться */
  max-height: 86vh;
  background: #f3f4f5;
  border-radius: 24px;
  padding: 18px 16px 16px;
  box-shadow: 0 18px 40px rgba(0,0,0,0.35);
  animation: cal-app-pop 450ms ease-out; /* используем твой keyframes */
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.event-header{
  display:flex;
  align-items:center;
  margin-bottom: 10px;
}
.event-back{
  width: 34px;
  height: 34px;
  border-radius: 50%;
  border:none;
  background: transparent;
  display:flex;
  align-items:center;
  justify-content:center;
  cursor:pointer;
}
.event-back svg{
  width: 18px;
  height: 18px;
  stroke:#000;
  stroke-width:2.4;
  fill:none;
}

.event-body{
  background: #ffffff;
  border-radius: 24px;
  padding: 14px 14px 16px;

  /* скролл, если контента много (например, раскрыта периодичность) */
  flex: 1 1 auto;
  overflow-y: auto;
  -webkit-overflow-scrolling: touch;
}

.event-title{
  text-align:center;
  font-size: 20px;
  font-weight: 700;
  margin: 0 0 10px;
}

.event-label{
  text-align:center;
  font-size: 18px;
  font-weight: 700;
  margin: 14px 0 8px;
}

/* сегмент "Тип события" */
.event-type-shell{
  background:#d9d9d9;
  border-radius: 16px;
  padding: 8px;
  display:flex;
  gap: 8px;
  justify-content: space-between;
  align-items:center;
}
.event-pill{
  flex: 1 1 0;
  height: 34px;
  border-radius: 14px;
  border:none;
  font-weight: 700;
  cursor:pointer;
  color:#000;
}
.event-pill.income{ background:#b6ff2a; }
.event-pill.expense{ background:#ff2a2a; }

/* режим "оставить одну кнопку по центру" */
.event-type-shell.single{
  justify-content:center;
}
.event-type-shell.single .event-pill{
  flex: 0 0 58%;
}
.event-pill.hidden{
  display:none !important;
}

/* инпуты */
.event-input{
  width: 100%;
  height: 44px;
  border-radius: 14px;
  border: none;
  outline: none;
  background: #d9d9d9;
  padding: 0 14px;
  font-size: 16px;
  box-sizing:border-box;
}

/* select выглядит как инпут */
select.event-input{
  -webkit-appearance: none;
  -moz-appearance: none;
  appearance: none;
}

/* цветовой инпут чуть плотнее */
.event-input-color{
  padding: 0 10px;
}
.event-input-color::-webkit-color-swatch-wrapper{ padding: 0; }
.event-input-color::-webkit-color-swatch{ border: none; border-radius: 10px; }


/* периодичность */
.event-dd{
  position: relative;
}
.event-dd-head{
  width: 100%;
  min-height: 44px;
  border-radius: 14px;
  border:none;
  outline:none;
  background:#d9d9d9;
  display:flex;
  align-items:center;
  gap: 10px;
  padding: 8px 12px;
  box-sizing:border-box;
  cursor:pointer;
}
.event-dd-caret{
  width: 18px;
  height: 18px;
  display:flex;
  align-items:center;
  justify-content:center;
  flex: 0 0 18px;
  opacity: 0.75;
}
.event-dd-caret svg{
  width: 18px; height: 18px;
  fill:none; stroke:#000; stroke-width:2.2;
}

.event-dd-text{
  flex: 1;
  display:flex;
  flex-direction: column;
  gap: 2px;
}
.event-dd-status{
  font-size: 13px;
  font-weight: 700;
  line-height: 1.1;
  display:none; /* показываем только когда выбран вариант */
}
.event-dd-value{
  font-size: 15px;
  font-weight: 500;
  line-height: 1.1;
}

.event-dd.open .event-dd-status{ display:block; }
.event-dd.chosen .event-dd-status{ display:block; }
.event-dd.chosen .event-dd-status{ content:""; }

.event-dd-list{
  display:none;
  margin-top: 8px;
}
.event-dd.open .event-dd-list{
  display:block;
}
.event-dd-option{
  width: 100%;
  height: 34px;
  border-radius: 12px;
  border:none;
  margin: 6px 0;
  background:#ffffff;
  font-weight: 600;
  cursor:pointer;
}
.event-dd-option.active{
  background:#9b9b9b;
  color:#000;
}

.event-done{
  margin-top: 14px;
  width: 100%;
  height: 50px;
  border-radius: 26px;
  border:none;
  background:#000;
  color:#fff;
  font-weight: 700;
  letter-spacing: 0.04em;
  cursor:pointer;
}

/* точки событий для добавленных событий */
.cal-dot.income { background:#19c37d; }
.cal-dot.expense{ background:#ff3b30; }

</style>
</head>

<body>

<div class="app">

  <h1><span>A-Спокойствие</span> - это когда деньги под контролем</h1>

  <!-- Диаграммы -->
  <div class="charts-card" id="chartsCard">
    <!-- Доходы -->
    <div class="chart-box" data-analytics-type="income" role="button" tabindex="0" aria-label="Открыть аналитику: доходы">
      <div class="donut">
        <svg viewBox="0 0 80 80" aria-hidden="true">
          <path class="income-arc-1"
                d="M 41.88 4.05 A 36 36 0 0 1 53.49 6.62 L 48.99 17.75 A 24 24 0 0 0 41.26 16.03 Z" />
          <path class="income-arc-2"
                d="M 56.90 8.21 A 36 36 0 0 1 31.90 75.08 L 34.60 63.38 A 24 24 0 0 0 51.27 18.81 Z" />
          <path class="income-arc-3"
                d="M 28.28 74.04 A 36 36 0 0 1 10.88 61.16 L 20.58 54.11 A 24 24 0 0 0 32.19 62.69 Z" />
          <path class="income-arc-4"
                d="M 8.82 58.00 A 36 36 0 0 1 4.14 36.86 L 16.09 37.91 A 24 24 0 0 0 19.22 52.00 Z" />
          <path class="income-arc-5"
                d="M 4.66 33.13 A 36 36 0 0 1 14.99 14.10 L 23.33 22.74 A 24 24 0 0 0 16.44 35.42 Z" />
          <path class="income-arc-6"
                d="M 17.84 11.63 A 36 36 0 0 1 38.12 4.05 L 38.74 16.03 A 24 24 0 0 0 25.22 21.09 Z" />
        </svg>
      </div>
      <div class="chart-label">Доходы</div>
    </div>

    <!-- Расходы -->
    <div class="chart-box" data-analytics-type="expense" role="button" tabindex="0" aria-label="Открыть аналитику: расходы">
      <div class="donut">
        <svg viewBox="0 0 80 80" aria-hidden="true">
          <path class="expense-arc-1"
                d="M 40.00 4.00
                   A 36 36 0 0 1 76.00 40.00
                   L 64.00 40.00
                   A 24 24 0 0 0 40.00 16.00 Z" />
          <path class="expense-arc-2"
                d="M 75.80 43.76
                   A 36 36 0 0 1 69.12 61.16
                   L 59.42 54.11
                   A 24 24 0 0 0 63.87 42.51 Z" />
          <path class="expense-arc-3"
                d="M 66.75 64.09
                   A 36 36 0 0 1 38.74 75.98
                   L 39.16 63.99
                   A 24 24 0 0 0 57.84 56.06 Z" />
          <path class="expense-arc-4"
                d="M 34.99 75.65
                   A 36 36 0 0 1 4.79 47.48
                   L 16.52 44.99
                   A 24 24 0 0 0 36.66 63.77 Z" />
          <path class="expense-arc-5"
                d="M 4.20 43.76
                   A 36 36 0 0 1 7.11 25.36
                   L 18.07 30.24
                   A 24 24 0 0 0 16.13 42.51 Z" />
          <path class="expense-arc-6"
                d="M 8.82 22.00
                   A 36 36 0 0 1 36.24 4.20
                   L 37.49 16.13
                   A 24 24 0 0 0 19.22 28.00 Z" />
        </svg>
      </div>
      <div class="chart-label">Расходы</div>
    </div>
  </div>

  <!-- Полоска здоровья -->
  <div class="health">
    <div class="health-label">Ваши очки здоровья</div>
    <div class="health-bar">
      <div class="health-fill"></div>
      <div class="health-heart">
        <svg viewBox="0 0 24 24" aria-hidden="true">
          <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6.02 4.02 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 17.98 4 20 6.02 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
        </svg>
      </div>
    </div>
    <div class="health-value">100/100</div>
  </div>

<div class="tasks-wrap">
  <div class="tasks-card" id="tasksCard">
    <div class="tasks-slider" id="tasksSlider">
      <!-- День -->
      <div class="task-page" data-type="day">
        <h3>Задания дня</h3>

        <div class="tasks-short">
          <div class="task">
            <span>
              <span class="task-prefix">Задача 1:</span> Пройдите 1 урок
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 2:</span> Внести 100 рублей
            </span>
            <div class="check active"></div>
          </div>
        </div>

        <div class="tasks-full">
          <div class="task">
            <span>
              <span class="task-prefix">Задача 1:</span>
              Пройдите урок в разделе <span class="task-link">Обучение</span>
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 2:</span>
              Внесите 100 рублей на свой <span class="task-link">сберегательный счет</span>
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 3:</span>
              Прочитайте финансовые рекомендации в разделе
              <span class="task-link">Планирование</span>
            </span>
            <div class="check active"></div>
          </div>
        </div>
      </div>

      <!-- Неделя -->
      <div class="task-page" data-type="week">
        <h3>Задания недели</h3>

        <div class="tasks-short">
          <div class="task">
            <span>
              <span class="task-prefix">Задача 1:</span> Пройти 1 главу
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 2:</span> Сократить расходы
            </span>
            <div class="check active"></div>
          </div>
        </div>

        <div class="tasks-full">
          <div class="task">
            <span>
              <span class="task-prefix">Задача 1:</span>
              Завершите 3 главы в разделе <span class="task-link">Обучение</span>
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 2:</span>
              Сократите еженедельные траты минимум на
              <span class="task-link">10%</span>
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 3:</span>
              Пройдите один шаг на пути к вершине в разделе
              <span class="task-link">Мой Аверест</span>
            </span>
            <div class="check active"></div>
          </div>
        </div>
      </div>

      <!-- Месяц -->
      <div class="task-page" data-type="month">
        <h3>Задания месяца</h3>

        <div class="tasks-short">
          <div class="task">
            <span>
              <span class="task-prefix">Задача 1:</span> Распределить доход
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 2:</span> Покорите Аверест
            </span>
            <div class="check active"></div>
          </div>
        </div>

        <div class="tasks-full">
          <div class="task">
            <span>
              <span class="task-prefix">Задача 1:</span>
              Распределите месячный доход по целям в разделе
              <span class="task-link">Планирование</span>
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 2:</span>
              Пополните долгосрочные накопления минимум на
              <span class="task-link">5 000 ₽</span>
            </span>
            <div class="check active"></div>
          </div>
          <div class="task">
            <span>
              <span class="task-prefix">Задача 3:</span>
              Станьте легендой: Покорите
              <span class="task-link">Аверест</span>
            </span>
            <div class="check active"></div>
          </div>
        </div>
      </div>
    </div>

    <div class="dots">
      <div class="dot active"></div>
      <div class="dot"></div>
      <div class="dot"></div>
    </div>
  </div>

  <div class="tasks-tail" aria-hidden="true"></div>
  <div class="tasks-arrow" aria-hidden="true">
    <svg viewBox="0 0 24 24">
      <polyline points="6 9 12 15 18 9"></polyline>
    </svg>
  </div>
</div>

  <!-- ===== РАЗДЕЛЫ ===== -->
  <div class="finance-title">Ваше финздоровье</div>

  <div class="finance-main" id="financeMain">
    <div class="finance-text">Планирование и накопления</div>
    <img src="plan.png" alt="" class="finance-illustration finance-illustration-main">
  </div>

  <div class="finance-grid">
    <div class="finance-card blue" id="calendarCard">
      <div class="finance-text">Календарь поступлений</div>
      <img src="calendar.png" alt="" class="finance-illustration">
    </div>
    <a href="study.html" class="finance-card green finance-link">
      <div class="finance-text">Обучение финздоровью</div>
      <img src="study.png" alt="" class="finance-illustration">
    </a>
  </div>

</div>

<!-- ===== МЕНЮ ===== -->
<div class="navbar">
  <div class="nav-item active">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 3l9 8h-3v9h-5v-6H11v6H6v-9H3l9-8z"/>
      </svg>
    </div>
    <div class="nav-label">Главная</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M20 7H4V5h16v2zm0 4H4V9h16v2zm0 4H4v-2h16v2zm0 4H4v-2h16v2z"/>
      </svg>
    </div>
    <div class="nav-label">Платежи</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M12 21.35l-1.45-1.32C5.4 15.36 2 12.28 2 8.5 2 6.02 4.02 4 6.5 4c1.74 0 3.41.81 4.5 2.09C12.09 4.81 13.76 4 15.5 4 17.98 4 20 6.02 20 8.5c0 3.78-3.4 6.86-8.55 11.54L12 21.35z"/>
      </svg>
    </div>
    <div class="nav-label">Выгода</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M11 7h2v6h-2V7zm1 13c-4.41 0-8-3.59-8-8s3.59-8 8-8 8 3.59 8 8-3.59 8-8 8zm0-18C6.48 2 2 6.48 2 12s4.48 10 10 10 10-4.48 10-10S17.52 2 12 2z"/>
      </svg>
    </div>
    <div class="nav-label">История</div>
  </div>
  <div class="nav-item">
    <div class="nav-icon">
      <svg viewBox="0 0 24 24" aria-hidden="true">
        <path d="M4 4h16v10H5.17L4 15.17V4zm0-2C2.9 2 2 2.9 2 4v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2H4z"/>
      </svg>
    </div>
    <div class="nav-label">Чаты</div>
  </div>
</div>

<!-- МОДАЛЬНОЕ ОКНО КАЛЕНДАРЯ -->
<div class="calendar-overlay" id="calendarOverlay">
  <div class="cal-app">
    <header class="cal-header">
      <button class="cal-back" id="calCloseBtn" aria-label="Закрыть">
        <svg viewBox="0 0 24 24">
          <polyline points="15 6 9 12 15 18" stroke-linecap="round" stroke-linejoin="round"></polyline>
        </svg>
      </button>
      <div class="cal-title">календарь движения денег</div>
      <div style="width:32px;"></div>
    </header>

    <main class="cal-card">
      <div class="cal-month-header">
        <button class="cal-month-nav" id="calPrevMonth" aria-label="Предыдущий месяц">
          <svg viewBox="0 0 24 24">
            <polyline points="14 6 10 12 14 18" stroke-linecap="round" stroke-linejoin="round"></polyline>
          </svg>
        </button>
        <div class="cal-month-title" id="calMonthName">Январь</div>
        <button class="cal-month-nav" id="calNextMonth" aria-label="Следующий месяц">
          <svg viewBox="0 0 24 24">
            <polyline points="10 6 14 12 10 18" stroke-linecap="round" stroke-linejoin="round"></polyline>
          </svg>
        </button>
      </div>

      <section class="cal-calendar" aria-label="Календарь">
        <div class="cal-weekdays">
          <div>П</div>
          <div>В</div>
          <div>С</div>
          <div>Ч</div>
          <div>П</div>
          <div>С</div>
          <div>В</div>
        </div>
        <div class="cal-days" id="calDays"></div>
      </section>

      <div class="cal-selected-info" id="calSelectedInfo"></div>

      <section class="cal-legend" id="calLegend"></section>

      <section class="cal-add-section">
        <button class="cal-add-btn" type="button">Добавить событие</button>
      </section>
    </main>
  </div>
</div>
<!-- МОДАЛЬНОЕ ОКНО ДОБАВЛЕНИЯ СОБЫТИЯ -->
<div class="event-overlay" id="eventOverlay">
  <div class="event-app" role="dialog" aria-modal="true">
    <div class="event-header">
      <button class="event-back" id="eventCloseBtn" aria-label="Назад">
        <svg viewBox="0 0 24 24">
          <polyline points="15 6 9 12 15 18" stroke-linecap="round" stroke-linejoin="round"></polyline>
        </svg>
      </button>
      <div style="flex:1;"></div>
    </div>

    <div class="event-body">
      <div class="event-title">Тип события</div>

      <div class="event-type-shell" id="eventTypeShell">
        <button class="event-pill income" id="pillIncome" type="button">Поступление</button>
        <button class="event-pill expense" id="pillExpense" type="button">Трата</button>
      </div>

      <div class="event-label">Сумма</div>
      <input class="event-input" id="eventSum" type="number" min="1" step="1" inputmode="numeric" placeholder="" />

      <div class="event-label">Название</div>
      <input class="event-input" id="eventName" type="text" placeholder="" />

      
      <div class="event-label">Категория</div>
      <select class="event-input" id="eventCategory"></select>

      <div class="event-label" id="newCatLabel" style="display:none;">Новая категория</div>
      <input class="event-input" id="eventNewCategory" type="text" placeholder="Например: Кафе" style="display:none;" />

      <div class="event-label">Цвет</div>
      <input class="event-input event-input-color" id="eventColor" type="color" value="#0ea768" />

      <div class="event-label">Дата операции</div>
      <input class="event-input" id="eventDate" type="text" placeholder="xx.xx.20xx" />

      <div class="event-label">Периодичность</div>
      <div class="event-dd" id="eventDD">
        <div class="event-dd-head" id="eventDDHead" tabindex="0" role="button" aria-expanded="false">
          <div class="event-dd-caret" aria-hidden="true">
            <svg viewBox="0 0 24 24">
              <polyline points="6 9 12 15 18 9" stroke-linecap="round" stroke-linejoin="round"></polyline>
            </svg>
          </div>
          <div class="event-dd-text">
            <div class="event-dd-status" id="eventDDStatus">Выбрано:</div>
            <div class="event-dd-value" id="eventDDValue">Не выбрано</div>
          </div>
        </div>

        <div class="event-dd-list" id="eventDDList">
          <button class="event-dd-option" type="button" data-value="Ежедневно">Ежедневно</button>
          <button class="event-dd-option" type="button" data-value="Еженедельно">Еженедельно</button>
          <button class="event-dd-option" type="button" data-value="Ежемесячно">Ежемесячно</button>
          <button class="event-dd-option" type="button" data-value="Ежегодно">Ежегодно</button>
        </div>
      </div>

      <button class="event-done" id="eventDoneBtn" type="button">ГОТОВО</button>
    </div>
  </div>
</div>

<script>
// ===== Слайдер и раскрытие заданий =====
let index = 0;
const slider = document.getElementById("tasksSlider");
const dots = document.querySelectorAll(".dot");
const maxIndex = 2;
const tasksCard = document.getElementById("tasksCard");

function updateSlider() {
  slider.style.transform = `translateX(-${index * 33.3333}%)`;
  dots.forEach((d, i) => d.classList.toggle("active", i === index));
}

dots.forEach((dot, i) => {
  dot.addEventListener("click", () => {
    index = i;
    updateSlider();
  });
});

/* свайп на тач-устройствах */
let startXTouch = 0;
slider.addEventListener("touchstart", e => {
  startXTouch = e.touches[0].clientX;
});
slider.addEventListener("touchend", e => {
  const diff = e.changedTouches[0].clientX - startXTouch;
  const threshold = 40;
  if (diff < -threshold && index < maxIndex) index++;
  if (diff > threshold && index > 0) index--;
  updateSlider();
});

/* свайп мышью для ПК */
let isMouseDown = false;
let startXMouse = 0;

slider.addEventListener("mousedown", e => {
  isMouseDown = true;
  startXMouse = e.clientX;
});

document.addEventListener("mouseup", e => {
  if (!isMouseDown) return;
  isMouseDown = false;
  const diff = e.clientX - startXMouse;
  const threshold = 40;
  if (diff < -threshold && index < maxIndex) index++;
  if (diff > threshold && index > 0) index--;
  updateSlider();
});

/* клик по странице — переключение краткий/подробный */
const tasksWrap = document.querySelector(".tasks-wrap");

document.querySelectorAll(".task-page").forEach(page => {
  page.addEventListener("click", () => {
    tasksCard.classList.toggle("expanded");
    tasksWrap.classList.toggle("expanded");
  });
});
const tasksArrow = document.querySelector(".tasks-arrow");

tasksArrow.addEventListener("click", (e) => {
  e.stopPropagation(); // чтобы клик не улетал дальше
  tasksCard.classList.toggle("expanded");
  tasksWrap.classList.toggle("expanded");
});


updateSlider();

/* переход в аналитику по клику на диаграммы (с учётом выбранного типа) */
(function () {
  const card = document.getElementById("chartsCard");
  if (!card) return;

  function go(type) {
    const url = new URL("analytics.html", window.location.href);
    url.searchParams.set("type", type); // income | expense
    window.location.href = url.toString();
  }

  // клик по конкретной диаграмме
  card.querySelectorAll("[data-analytics-type]").forEach((box) => {
    box.addEventListener("click", (e) => {
      e.stopPropagation();
      go(box.getAttribute("data-analytics-type"));
    });

    // доступность: Enter/Space
    box.addEventListener("keydown", (e) => {
      if (e.key === "Enter" || e.key === " ") {
        e.preventDefault();
        go(box.getAttribute("data-analytics-type"));
      }
    });
  });

  // если кликнули в «пустое» место карточки — открываем доходы по умолчанию
  card.addEventListener("click", () => go("income"));
})();

/* переход в планирование по клику на основную карточку */
document.getElementById("financeMain").onclick = (e) => {
  // не перехватываем клики по карточкам внутри (например, календарь)
  if (e.target.closest && e.target.closest("#calendarCard, .finance-link")) return;
  location.href = "finance.html";
};
</script>

<script>
// ===== ЛОГИКА МОДАЛЬНОГО КАЛЕНДАРЯ =====
const calendarOverlay = document.getElementById("calendarOverlay");
const calendarCard = document.getElementById("calendarCard");
const calCloseBtn = document.getElementById("calCloseBtn");

function openCalendar() {
  calendarOverlay.classList.add("active");
}

function closeCalendar() {
  calendarOverlay.classList.remove("active");
}

calendarCard.addEventListener("click", (e) => { e.stopPropagation(); openCalendar(); });
calCloseBtn.addEventListener("click", closeCalendar);
calendarOverlay.addEventListener("click", (e) => {
  if (e.target === calendarOverlay) closeCalendar();
});

// ===== МОДАЛКА "ДОБАВИТЬ СОБЫТИЕ" =====
const eventOverlay = document.getElementById("eventOverlay");
const eventCloseBtn = document.getElementById("eventCloseBtn");
const eventDoneBtn  = document.getElementById("eventDoneBtn");

const eventTypeShell = document.getElementById("eventTypeShell");
const pillIncome = document.getElementById("pillIncome");
const pillExpense = document.getElementById("pillExpense");

const eventSum  = document.getElementById("eventSum");
const eventName = document.getElementById("eventName");
const eventDate = document.getElementById("eventDate");

const eventDD      = document.getElementById("eventDD");
const eventDDHead  = document.getElementById("eventDDHead");
const eventDDList  = document.getElementById("eventDDList");
const eventDDValue = document.getElementById("eventDDValue");
const eventDDStatus= document.getElementById("eventDDStatus");

let selectedEventType = "income";     // income | expense
let selectedPeriod = "";              // строка периодичности
let calSelectedDay = null;            // выбранный день в календаре

function openEventModal() {
  // по ТЗ: окно добавления — всплывающее, задний фон — главный экран
  closeCalendar();
  eventOverlay.classList.add("active");
}

function closeEventModal() {
  eventOverlay.classList.remove("active");
  // закрываем выпадашку при закрытии
  eventDD.classList.remove("open");
  eventDDHead.setAttribute("aria-expanded", "false");
}

eventCloseBtn.addEventListener("click", closeEventModal);
eventOverlay.addEventListener("click", (e) => {
  if (e.target === eventOverlay) closeEventModal();
});

// --- Тип события: “две кнопки” -> “одна по центру”, повторный клик возвращает две
function setType(type) {
  selectedEventType = type;

  // если сейчас обе видимы — схлопываем в одну по центру
  const isSingle = eventTypeShell.classList.contains("single");

  if (!isSingle) {
    eventTypeShell.classList.add("single");
    if (type === "income") {
      pillExpense.classList.add("hidden");
      pillIncome.classList.remove("hidden");
    } else {
      pillIncome.classList.add("hidden");
      pillExpense.classList.remove("hidden");
    }
    return;
  }

  // если уже single и кликнули по текущей — разворачиваем обратно в две
  // если single и кликнули “другой” (вдруг ты вернешь вторую кнопкой/кодом) — просто переключим
  if (type === selectedEventType) {
    eventTypeShell.classList.remove("single");
    pillIncome.classList.remove("hidden");
    pillExpense.classList.remove("hidden");
  } else {
    setType(type);
  }
}

pillIncome.addEventListener("click", () => setType("income"));
pillExpense.addEventListener("click", () => setType("expense"));

// --- Периодичность: раскрытие, выбор, “Не выбрано” -> “Выбрано:”
function toggleDD() {
  const open = eventDD.classList.toggle("open");
  eventDDHead.setAttribute("aria-expanded", String(open));
  // если уже выбран вариант — показываем “Выбрано:” даже когда закрыто
  if (selectedPeriod) eventDD.classList.add("chosen");
}

eventDDHead.addEventListener("click", (e) => {
  e.stopPropagation();
  toggleDD();
});

document.addEventListener("click", (e) => {
  // клик вне dropdown — закрыть
  if (!eventDD.contains(e.target)) {
    eventDD.classList.remove("open");
    eventDDHead.setAttribute("aria-expanded", "false");
  }
});

eventDDList.querySelectorAll(".event-dd-option").forEach((btn) => {
  btn.addEventListener("click", (e) => {
    e.stopPropagation();
    selectedPeriod = btn.dataset.value || "";
    eventDDValue.textContent = selectedPeriod || "Не выбрано";
    eventDDStatus.textContent = "Выбрано:";
    eventDD.classList.add("chosen");

    // подсветка выбранного
    eventDDList.querySelectorAll(".event-dd-option").forEach(b => b.classList.remove("active"));
    btn.classList.add("active");

    // по фото 5 список остается раскрытым — оставляем open
    eventDD.classList.add("open");
    eventDDHead.setAttribute("aria-expanded", "true");
  });
});


// Календарь
const CAL_MONTHS = [
  "Январь","Февраль","Март","Апрель","Май","Июнь",
  "Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"
];

// ===== LocalStorage (категории + события) =====
const LS_KEYS = {
  categories: "finz_calendar_categories_v1",
  events: "finz_calendar_events_v1",
  seeded: "finz_calendar_seeded_v1"
};

function loadJSON(key, fallback) {
  try {
    const raw = localStorage.getItem(key);
    if (!raw) return fallback;
    return JSON.parse(raw);
  } catch (e) {
    return fallback;
  }
}

function saveJSON(key, value) {
  localStorage.setItem(key, JSON.stringify(value));
}

function uid(prefix = "id") {
  return `${prefix}_${Math.random().toString(16).slice(2)}_${Date.now().toString(16)}`;
}

function toISODateString(y, m, d) {
  const mm = String(m + 1).padStart(2, "0");
  const dd = String(d).padStart(2, "0");
  return `${y}-${mm}-${dd}`;
}

function parseDDMMYYYY(str) {
  const m = /^(\d{2})\.(\d{2})\.(\d{4})$/.exec((str || "").trim());
  if (!m) return null;
  const dd = Number(m[1]);
  const mm = Number(m[2]);
  const yy = Number(m[3]);
  if (!yy || mm < 1 || mm > 12 || dd < 1 || dd > 31) return null;
  const dt = new Date(yy, mm - 1, dd);
  if (dt.getFullYear() !== yy || dt.getMonth() !== (mm - 1) || dt.getDate() !== dd) return null;
  return dt;
}

function formatDDMMYYYY(d, m, y){
  const dd = String(d).padStart(2,"0");
  const mm = String(m+1).padStart(2,"0");
  return `${dd}.${mm}.${y}`;
}

function clampDayOfMonth(year, month, day) {
  const dim = new Date(year, month + 1, 0).getDate();
  return Math.min(day, dim);
}

function addMonths(date, months) {
  const y = date.getFullYear();
  const m = date.getMonth();
  const d = date.getDate();
  const nm = m + months;
  const ny = y + Math.floor(nm / 12);
  const nmo = ((nm % 12) + 12) % 12;
  const nd = clampDayOfMonth(ny, nmo, d);
  return new Date(ny, nmo, nd);
}

function addDays(date, days) {
  const dt = new Date(date);
  dt.setDate(dt.getDate() + days);
  return dt;
}

function monthDiff(a, b) {
  return (b.getFullYear() - a.getFullYear()) * 12 + (b.getMonth() - a.getMonth());
}

// Инициализация категорий + демо-событий (один раз)
function ensureSeedData() {
  const seeded = localStorage.getItem(LS_KEYS.seeded);
  if (seeded) return;

  const defaultCategories = [
    { id: "salary", name: "Зарплата", color: "#0ea768" },
    { id: "okko",   name: "Подписка OKKO", color: "#e91e63" },
    { id: "rent",   name: "Оплата жилья", color: "#fdd835" },
    { id: "credit", name: "% по кредиту", color: "#ff9800" }
  ];
  saveJSON(LS_KEYS.categories, defaultCategories);

  // Пример из текущего прототипа: январь 2025
  const demoEvents = [
    { id: uid("ev"), type: "income",  amount: 0, title: "Зарплата", dateISO: "2025-01-06", recurrence: "none", categoryId: "salary", color: "#0ea768" },
    { id: uid("ev"), type: "income",  amount: 0, title: "Зарплата", dateISO: "2025-01-17", recurrence: "none", categoryId: "salary", color: "#0ea768" },
    { id: uid("ev"), type: "expense", amount: 0, title: "% по кредиту", dateISO: "2025-01-19", recurrence: "none", categoryId: "credit", color: "#ff9800" },
    { id: uid("ev"), type: "expense", amount: 0, title: "Подписка OKKO", dateISO: "2025-01-25", recurrence: "none", categoryId: "okko", color: "#e91e63" }
  ];
  saveJSON(LS_KEYS.events, demoEvents);

  localStorage.setItem(LS_KEYS.seeded, "1");
}

ensureSeedData();

function getCategories() {
  return loadJSON(LS_KEYS.categories, []);
}

function saveCategories(cats) {
  saveJSON(LS_KEYS.categories, cats);
}

function getEvents() {
  return loadJSON(LS_KEYS.events, []);
}

function saveEvents(events) {
  saveJSON(LS_KEYS.events, events);
}

function deleteEventById(eventId) {
  const events = getEvents();
  const next = events.filter(ev => ev.id !== eventId);
  saveEvents(next);
}

function getCategoryById(id) {
  const cats = getCategories();
  return cats.find(c => c.id === id) || null;
}

function upsertCategory(name, color) {
  const trimmed = (name || "").trim();
  if (!trimmed) return null;

  const cats = getCategories();
  const existing = cats.find(c => c.name.toLowerCase() === trimmed.toLowerCase());
  if (existing) {
    // если пользователь выбрал другой цвет — обновим
    existing.color = color || existing.color;
    saveCategories(cats);
    return existing;
  }

  const cat = { id: uid("cat"), name: trimmed, color: color || "#2563eb" };
  cats.push(cat);
  saveCategories(cats);
  return cat;
}

// ===== UI: категория/цвет в форме =====
const eventCategory = document.getElementById("eventCategory");
const eventColor = document.getElementById("eventColor");
const eventNewCategory = document.getElementById("eventNewCategory");
const newCatLabel = document.getElementById("newCatLabel");

function renderCategorySelect(selectedId = "") {
  const cats = getCategories();
  eventCategory.innerHTML = "";

  const placeholder = document.createElement("option");
  placeholder.value = "";
  placeholder.textContent = "Выберите категорию";
  placeholder.disabled = true;
  placeholder.selected = !selectedId;
  eventCategory.appendChild(placeholder);

  cats.forEach((c) => {
    const opt = document.createElement("option");
    opt.value = c.id;
    opt.textContent = c.name;
    if (c.id === selectedId) opt.selected = true;
    eventCategory.appendChild(opt);
  });

  const optNew = document.createElement("option");
  optNew.value = "__new__";
  optNew.textContent = "＋ Новая категория";
  eventCategory.appendChild(optNew);
}

function showNewCategoryFields(show) {
  newCatLabel.style.display = show ? "block" : "none";
  eventNewCategory.style.display = show ? "block" : "none";
  if (!show) eventNewCategory.value = "";
}

eventCategory.addEventListener("change", () => {
  const val = eventCategory.value;
  if (val === "__new__") {
    showNewCategoryFields(true);
    // цвет по умолчанию оставляем как есть
  } else {
    showNewCategoryFields(false);
    const cat = getCategoryById(val);
    if (cat) eventColor.value = cat.color;
  }
});

// ===== Рендер легенды =====
const calLegend = document.getElementById("calLegend");

function renderLegend() {
  const cats = getCategories();
  calLegend.innerHTML = "";
  cats.forEach((c) => {
    const item = document.createElement("div");
    item.className = "cal-legend-item";

    const dot = document.createElement("span");
    dot.className = "cal-legend-dot";
    dot.style.background = c.color;

    const label = document.createElement("span");
    label.textContent = c.name;

    item.appendChild(dot);
    item.appendChild(label);
    calLegend.appendChild(item);
  });
}

// ===== Рендер календаря =====
const calDaysContainer = document.getElementById("calDays");
const calInfo = document.getElementById("calSelectedInfo");
const calMonthNameEl = document.getElementById("calMonthName");
const calPrevBtn = document.getElementById("calPrevMonth");
const calNextBtn = document.getElementById("calNextMonth");

let calCurrentYear = 2025;
let calCurrentMonth = 0;
calSelectedDay = null; // выбранный день в календаре

function getOccurrencesForMonth(year, month) {
  const events = getEvents();
  const map = {}; // day -> [{...}]
  const monthStart = new Date(year, month, 1);
  const monthEnd = new Date(year, month + 1, 0, 23, 59, 59, 999);

  for (const ev of events) {
    const start = new Date(ev.dateISO + "T00:00:00");
    if (Number.isNaN(start.getTime())) continue;

    // горизонт: 12 месяцев вперёд от даты старта
    const horizonEnd = addMonths(start, 12);

    // если текущий месяц полностью вне горизонта — пропускаем
    if (monthStart > horizonEnd) continue;
    if (monthEnd < start) continue;

    const rec = (ev.recurrence || "none").toLowerCase();

    const addOcc = (dt) => {
      if (dt.getFullYear() !== year || dt.getMonth() !== month) return;
      const day = dt.getDate();
      if (!map[day]) map[day] = [];
      map[day].push(ev);
    };

    if (rec === "none" || !rec) {
      addOcc(start);
      continue;
    }

    if (rec === "daily") {
      // первое попадание в месяц
      let dt = new Date(start);
      if (dt < monthStart) {
        const diffDays = Math.floor((monthStart - dt) / (24 * 3600 * 1000));
        dt = addDays(dt, diffDays);
      }
      while (dt <= monthEnd && dt <= horizonEnd) {
        addOcc(dt);
        dt = addDays(dt, 1);
      }
      continue;
    }

    if (rec === "weekly") {
      let dt = new Date(start);
      if (dt < monthStart) {
        const diffDays = Math.floor((monthStart - dt) / (24 * 3600 * 1000));
        const shiftWeeks = Math.floor(diffDays / 7);
        dt = addDays(dt, shiftWeeks * 7);
        while (dt < monthStart) dt = addDays(dt, 7);
      }
      while (dt <= monthEnd && dt <= horizonEnd) {
        addOcc(dt);
        dt = addDays(dt, 7);
      }
      continue;
    }

    if (rec === "monthly") {
      const startMonth = new Date(start.getFullYear(), start.getMonth(), 1);
      const targetMonth = new Date(year, month, 1);

      const mdiff = monthDiff(startMonth, targetMonth);
      if (mdiff < 0) continue;

      // начинаем с первого месяца, который попадает
      let k = mdiff;
      let dt = addMonths(start, k);
      // подстрахуемся (если из-за клампа пролезли назад)
      while (dt < monthStart) {
        k += 1;
        dt = addMonths(start, k);
      }

      while (dt <= monthEnd && dt <= horizonEnd) {
        addOcc(dt);
        k += 1;
        dt = addMonths(start, k);
      }
      continue;
    }

    if (rec === "yearly") {
      // оставляем на всякий случай (у тебя в списке есть "Ежегодно")
      let dt = new Date(start);
      if (dt < monthStart) {
        const yearsShift = year - start.getFullYear();
        dt = new Date(start.getFullYear() + yearsShift, start.getMonth(), clampDayOfMonth(start.getFullYear() + yearsShift, start.getMonth(), start.getDate()));
        if (dt < monthStart) dt = new Date(dt.getFullYear() + 1, dt.getMonth(), dt.getDate());
      }
      while (dt <= monthEnd && dt <= horizonEnd) {
        addOcc(dt);
        dt = new Date(dt.getFullYear() + 1, dt.getMonth(), dt.getDate());
      }
      continue;
    }
  }

  // сортировка для стабильного порядка точек
  for (const day of Object.keys(map)) {
    map[day].sort((a, b) => {
      if (a.type !== b.type) return a.type === "income" ? -1 : 1;
      const ca = getCategoryById(a.categoryId)?.name || "";
      const cb = getCategoryById(b.categoryId)?.name || "";
      return ca.localeCompare(cb, "ru");
    });
  }

  return map;
}

function renderCalendar(year, month) {
  calDaysContainer.innerHTML = "";
  calInfo.textContent = "";
  calMonthNameEl.textContent = CAL_MONTHS[month];

  renderLegend();

  const eventsMap = getOccurrencesForMonth(year, month);

  const daysInMonth = new Date(year, month + 1, 0).getDate();
  const firstDay = new Date(year, month, 1).getDay();
  const offset = (firstDay + 6) % 7; // понедельник первый

  for (let i = 0; i < offset; i++) {
    const empty = document.createElement("button");
    empty.className = "cal-day disabled";
    empty.type = "button";
    calDaysContainer.appendChild(empty);
  }

  for (let day = 1; day <= daysInMonth; day++) {
    const dayEl = document.createElement("button");
    dayEl.type = "button";
    dayEl.className = "cal-day";

    const num = document.createElement("div");
    num.className = "cal-day-number";
    num.textContent = day;
    dayEl.appendChild(num);

    const occurrences = eventsMap[day] || [];
    const eventsContainer = document.createElement("div");
    eventsContainer.className = "cal-day-events";

    // точки событий: ограничиваем количество, чтобы не “расползалось” по экрану
    const MAX_DOTS_PER_DAY = 3;
    const shown = occurrences.slice(0, MAX_DOTS_PER_DAY);

    shown.forEach((ev) => {
      const cat = getCategoryById(ev.categoryId);
      const dot = document.createElement("span");
      dot.className = "cal-dot";
      dot.style.background = (cat?.color || ev.color || (ev.type === "income" ? "#19c37d" : "#ff3b30"));
      eventsContainer.appendChild(dot);
    });

    if (occurrences.length > MAX_DOTS_PER_DAY) {
      const more = document.createElement("span");
      more.className = "cal-more";
      more.textContent = "+" + String(occurrences.length - MAX_DOTS_PER_DAY);
      eventsContainer.appendChild(more);
    }

    dayEl.appendChild(eventsContainer);
    calDaysContainer.appendChild(dayEl);

    dayEl.addEventListener("click", () => {
      document.querySelectorAll(".cal-day.selected").forEach((d) => d.classList.remove("selected"));
      dayEl.classList.add("selected");
      calSelectedDay = day;

      if (occurrences.length) {
        calInfo.style.opacity = 0;
        setTimeout(() => {
          const header =
            "События <span>" +
            day +
            " " +
            CAL_MONTHS[month].toLowerCase() +
            "</span>:";

          const list = document.createElement("div");
          list.className = "cal-event-list";

          occurrences.forEach((ev) => {
            const cat = getCategoryById(ev.categoryId);
            const color = (cat?.color || ev.color || (ev.type === "income" ? "#19c37d" : "#ff3b30"));

            const row = document.createElement("div");
            row.className = "cal-event-row";

            const dot = document.createElement("span");
            dot.className = "cal-event-dot";
            dot.style.background = color;

            const title = document.createElement("div");
            title.className = "cal-event-title";
            const amount = ev.amount && Number(ev.amount) > 0 ? ` — ${Number(ev.amount).toLocaleString("ru-RU")}₽` : "";
            title.textContent = (ev.title || cat?.name || "Событие") + amount;

            const del = document.createElement("button");
            del.type = "button";
            del.className = "cal-event-del";
            del.textContent = "Удалить";
            del.addEventListener("click", (e) => {
              e.stopPropagation();
              const ok = confirm("Удалить событие? Оно исчезнет из календаря (включая повторы, если они есть).");
              if (!ok) return;

              deleteEventById(ev.id);
              renderCalendar(calCurrentYear, calCurrentMonth);

              // пере-выделим этот же день, чтобы список обновился
              const dayButtons = calDaysContainer.querySelectorAll(".cal-day:not(.disabled)");
              const btn = Array.from(dayButtons).find(b => b.querySelector(".cal-day-number")?.textContent == String(day));
              if (btn) btn.click();
            });

            row.appendChild(dot);
            row.appendChild(title);
            row.appendChild(del);

            list.appendChild(row);
          });

          calInfo.innerHTML = header;
          calInfo.appendChild(list);
          calInfo.style.opacity = 1;
        }, 120);
      } else {
        calInfo.style.opacity = 0;
        setTimeout(() => {
          calInfo.textContent =
            "Событий " + day + " " + CAL_MONTHS[month].toLowerCase() + " нет";
          calInfo.style.opacity = 1;
        }, 120);
      }
  });
  }
}

// сброс на всякий случай (чтобы не было "накопления")
calPrevBtn.onclick = null;
calNextBtn.onclick = null;

calPrevBtn.onclick = () => {
  calCurrentMonth--;
  if (calCurrentMonth < 0) {
    calCurrentMonth = 11;
    calCurrentYear--;
  }
  calSelectedDay = null;
  renderCalendar(calCurrentYear, calCurrentMonth);
};

calNextBtn.onclick = () => {
  calCurrentMonth++;
  if (calCurrentMonth > 11) {
    calCurrentMonth = 0;
    calCurrentYear++;
  }
  calSelectedDay = null;
  renderCalendar(calCurrentYear, calCurrentMonth);
};


// Кнопка "Добавить событие" в календаре
// Кнопка "Добавить событие" в календаре
const calAddBtn = document.querySelector(".cal-add-btn");
if (calAddBtn) {
  calAddBtn.onclick = null;
  calAddBtn.onclick = () => {
      const day = calSelectedDay || 1;
      eventDate.value = formatDDMMYYYY(day, calCurrentMonth, calCurrentYear);

      // сброс формы
      eventSum.value = "";
      eventName.value = "";
      selectedPeriod = "";
      eventDDValue.textContent = "Не выбрано";
      eventDD.classList.remove("chosen");
      eventDDList.querySelectorAll(".event-dd-option").forEach(b => b.classList.remove("active"));
      eventTypeShell.classList.remove("single");
      pillIncome.classList.remove("hidden");
      pillExpense.classList.remove("hidden");
      selectedEventType = "income";

      renderCategorySelect("");
      showNewCategoryFields(false);
      // дефолтный цвет — зелёный для поступления, красный для траты
      eventColor.value = (selectedEventType === "income") ? "#0ea768" : "#ff3b30";

      openEventModal();
  };
}


// UX: при смене типа события в форме — меняем цвет по умолчанию, если категория не выбрана
function syncDefaultColorByType() {
  if (!eventCategory.value || eventCategory.value === "__new__") {
    eventColor.value = (selectedEventType === "income") ? "#0ea768" : "#ff3b30";
  }
}
pillIncome.addEventListener("click", () => setTimeout(syncDefaultColorByType, 0));
pillExpense.addEventListener("click", () => setTimeout(syncDefaultColorByType, 0));

// Валидация суммы (не даём отрицательные/ноль)
eventSum.addEventListener("input", () => {
  const v = Number(eventSum.value);
  if (Number.isNaN(v)) return;
  if (v < 0) eventSum.value = String(Math.abs(v));
});

// "ГОТОВО" — сохраняем событие (+ периодичность) в localStorage, затем перерисовываем
// "ГОТОВО" — сохраняем событие (+ периодичность) в localStorage, затем перерисовываем
let __eventSaveLock = false;
eventDoneBtn.onclick = null;
eventDoneBtn.onclick = () => {
  if (__eventSaveLock) return;
  __eventSaveLock = true;
  eventDoneBtn.disabled = true;
  try {
      const name = (eventName.value || "").trim();
      const sumNum = Number(eventSum.value);

      if (!name) {
        alert("Введите название события.");
        return;
      }
      if (!Number.isFinite(sumNum) || sumNum <= 0) {
        alert("Введите сумму больше нуля.");
        return;
      }

      const dt = parseDDMMYYYY(eventDate.value) || new Date(calCurrentYear, calCurrentMonth, calSelectedDay || 1);

      // категория
      let catId = "";
      let color = (eventColor.value || "").trim() || (selectedEventType === "income" ? "#0ea768" : "#ff3b30");

      if (eventCategory.value === "__new__") {
        const newName = (eventNewCategory.value || "").trim();
        if (!newName) {
          alert("Введите название новой категории.");
          return;
        }
        const cat = upsertCategory(newName, color);
        catId = cat?.id || "";
      } else if (eventCategory.value) {
        catId = eventCategory.value;
        const cat = getCategoryById(catId);
        if (cat) color = cat.color;
      } else {
        // если пользователь не выбрал категорию — создадим по названию события (чтобы легенда была осмысленной)
        const cat = upsertCategory(name, color);
        catId = cat?.id || "";
      }

      // периодичность
      const recMap = {
        "Ежедневно": "daily",
        "Еженедельно": "weekly",
        "Ежемесячно": "monthly",
        "Ежегодно": "yearly"
      };
      const recurrence = recMap[selectedPeriod] || "none";

      const events = getEvents();
      events.push({
        id: uid("ev"),
        type: selectedEventType, // income | expense
        amount: Math.round(sumNum),
        title: name,
        dateISO: toISODateString(dt.getFullYear(), dt.getMonth(), dt.getDate()),
        recurrence,
        categoryId: catId,
        color
      });
      saveEvents(events);

      closeEventModal();
      renderCalendar(calCurrentYear, calCurrentMonth);

      // выделим день обратно
      const day = dt.getFullYear() === calCurrentYear && dt.getMonth() === calCurrentMonth ? dt.getDate() : (calSelectedDay || dt.getDate());
      const dayButtons = calDaysContainer.querySelectorAll(".cal-day:not(.disabled)");
      const btn = Array.from(dayButtons).find(b => b.querySelector(".cal-day-number")?.textContent == String(day));
      if (btn) btn.click();
  } finally {
    __eventSaveLock = false;
    eventDoneBtn.disabled = false;
  }
};


renderCalendar(calCurrentYear, calCurrentMonth);

</script>


</body>
</html>
