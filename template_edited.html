<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <title>Планирование — Альфа</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />

  <style>
    :root {
      --red: #ff3b30;
      --bg: #f3f3f5;
      --card-bg: #ffffff;
      --text-main: #111111;
      --text-sub: #868686;
      --shadow-soft: 0 8px 18px rgba(0, 0, 0, 0.08);
      --radius-card: 22px;
      --transition-fast: 0.25s ease-out;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }

    body {
      margin: 0;
      font-family: -apple-system, BlinkMacSystemFont, "SF Pro Text", system-ui, Roboto, sans-serif;
      background: #000;
      display: flex;
      justify-content: center;
    }

    .app-shell {
      background: var(--bg);
      width: 100%;
      max-width: 430px;
      min-height: 100vh;
      overflow: hidden;
      display: flex;
      flex-direction: column;
      position: relative;
    }

    @media (min-width: 500px) {
      .app-shell { margin: 16px 0; border-radius: 32px; box-shadow: 0 18px 40px rgba(0, 0, 0, 0.35); }
    }

    .app-scroll { flex: 1; overflow-y: auto; padding: 14px 18px 80px; }

    /* top bar */
    .top-bar {
      display: flex; align-items: center; gap: 12px;
      padding: 8px 18px 0;
      background: var(--bg);
      position: sticky; top: 0; z-index: 10;
    }
    .back-btn {
      width: 32px; height: 32px; border-radius: 999px;
      border: none; background: #fff;
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 4px 10px rgba(0,0,0,0.08);
      cursor: pointer;
      transition: transform var(--transition-fast), box-shadow var(--transition-fast), background var(--transition-fast);
    }
    .back-btn span { font-size: 19px; transform: translateX(-1px); }
    .back-btn:active { transform: scale(0.94) translateY(1px); box-shadow: 0 2px 5px rgba(0,0,0,0.08); background: #f8f8fa; }
    .top-title { font-weight: 700; font-size: 22px; color: var(--text-main); }

    /* fade-in animation */
    .fade-in-up {
      opacity: 0; transform: translateY(14px);
      transition: opacity 0.45s ease-out, transform 0.45s ease-out;
    }
    .fade-in-up.visible { opacity: 1; transform: translateY(0); }

    /* screens */
    .screens { position: relative; }
    .screen { opacity: 0; transform: translateX(12px); pointer-events: none; transition: opacity 0.24s ease-out, transform 0.24s ease-out; }
    .screen.active { opacity: 1; transform: translateX(0); pointer-events: auto; }

    .screen-placeholder { padding-top: 40px; text-align: center; color: var(--text-sub); font-size: 14px; }
    .screen-placeholder h2 { font-size: 20px; margin-bottom: 8px; color: var(--text-main); }

    /* Everest */
    .section-heading {
      text-align: center; margin: 10px 0 6px;
      font-size: 26px; font-weight: 800; color: var(--red);
    }

    .goal-title {
      text-align: center;
      font-weight: 700;
      font-size: 14px;
      color: #222;
      margin: 0 0 10px;
    }

    .everest-card {
      background: var(--red);
      border-radius: 28px;
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      overflow: hidden;
      color: #fff;
      margin-bottom: 14px;
    }

    .everest-banner {
      background: linear-gradient(135deg, #ff6b5a, #ff3b30);
      border-radius: 999px;
      padding: 8px 18px;
      text-align: center;
      font-size: 13px;
      font-weight: 600;
      margin-bottom: 10px;
      position: relative;
      overflow: hidden;
    }

    /* плавная подсветка + размытые границы блика */
    .everest-banner::after {
      content: "";
      position: absolute;
      top: -120%;
      left: -45%;
      width: 55%;
      height: 320%;
      background: radial-gradient(
        circle at 50% 50%,
        rgba(255, 255, 255, 0.85),
        rgba(255, 255, 255, 0.25),
        transparent 70%
      );
      filter: blur(6px);
      transform: translateX(-180%);
      animation: shimmer 4s ease-in-out infinite;
      pointer-events: none;
    }
    @keyframes shimmer {
      0%   { transform: translateX(-180%); opacity: 0; }
      15%  { opacity: 1; }
      70%  { transform: translateX(260%); opacity: 1; }
      100% { transform: translateX(260%); opacity: 0; }
    }

    .savings-pill {
      background: rgba(255,255,255,0.92);
      color: #111;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 900;
      display: inline-flex;
      align-items: center;
      gap: 8px;
      margin: 0 auto 10px;
      box-shadow: 0 8px 18px rgba(0,0,0,0.12);
    }
    .savings-pill .dot {
      width: 8px; height: 8px; border-radius: 50%;
      background: #09b35c;
      position: static; transform: none;
    }

    .progress-line {
      text-align:center;
      margin-top: 8px;
      font-size: 12px;
      color: rgba(255,255,255,0.92);
      font-weight: 800;
    }

    .everest-inner {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: #ff6041;
      height: 220px;
    }

    .everest-image {
      position: absolute;
      inset: 10px 40% 10px 10px;
      border-radius: 22px;
      background-image: url("everest-original.png");
      background-size: cover;
      background-position: center;
      background-repeat: no-repeat;
      overflow: hidden;
    }

    .everest-lines {
      position: absolute;
      inset: 16px 10px 16px 10px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      pointer-events: none;
      z-index: 1;
    }

    .everest-row { display: flex; align-items: center; font-size: 11px; color: #ffd6c4; }
    .row-line { flex: 1; height: 2px; border-radius: 999px; background: rgba(255,255,255,0.7); margin-right: 4px; }
    .row-label { width: 96px; text-align: right; font-weight: 900; letter-spacing: 0.02em; }

    .goal-star {
      position: absolute;
      font-size: 26px;
      color: rgba(255, 223, 166, 0.2);
      text-shadow: 0 0 0 transparent;
      transform: scale(0.9);
      opacity: 0.7;
      transition: transform 0.25s ease-out, opacity 0.25s ease-out, color 0.25s ease-out, text-shadow 0.25s ease-out;
      z-index: 2;
      pointer-events: none;
    }
    .goal-star.on {
      color: #ffe77a;
      opacity: 1;
      transform: scale(1.15);
      text-shadow: 0 0 10px rgba(255, 231, 122, 0.95);
      animation: star-pop 0.35s ease-out;
    }
    .goal-star.on.delay-0 { animation-delay: 0ms; }
    .goal-star.on.delay-1 { animation-delay: 120ms; }
    .goal-star.on.delay-2 { animation-delay: 240ms; }
    .goal-star.on.delay-3 { animation-delay: 360ms; }
    .goal-star.on.delay-4 { animation-delay: 480ms; }

    @keyframes star-pop {
      0% { transform: scale(0.6); opacity: 0; }
      60% { transform: scale(1.3); opacity: 1; }
      100% { transform: scale(1.15); opacity: 1; }
    }

    .everest-image .goal-star[data-ratio="1"]    { top: 30%; left: 60%; }
    .everest-image .goal-star[data-ratio="0.8"]  { top: 38%; left: 73%; }
    .everest-image .goal-star[data-ratio="0.5"]  { top: 53%; left: 47%; }
    .everest-image .goal-star[data-ratio="0.3"]  { top: 67%; left: 59%; }
    .everest-image .goal-star[data-ratio="0.05"] { top: 80%; left: 22%; }

    .info-block { margin-bottom: 10px; font-size: 13px; color: var(--text-sub); }
    .info-block strong { display: block; color: var(--text-main); font-size: 16px; margin-top: 2px; }

    .info-inline {
      display: flex; justify-content: space-between; align-items: baseline;
      font-size: 13px; color: var(--text-sub);
      margin-bottom: 8px;
      background: #ffffff;
      padding: 10px 14px;
      border-radius: 14px;
      box-shadow: 0 6px 12px rgba(0,0,0,0.04);
    }
    .info-inline strong { color: var(--text-main); font-size: 14px; }

    .goal-card {
      margin-bottom: 12px;
      background: #ffffff;
      border-radius: 18px;
      padding: 10px 12px 12px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.04);
      font-size: 12px;
      color: var(--text-sub);
    }
    .goal-row { display: flex; align-items: center; justify-content: space-between; gap: 10px; }
    .goal-row label { font-size: 13px; color: var(--text-main); font-weight: 900; }

    .goal-input-wrap { position: relative; flex: 1; }
    .input {
      width: 100%;
      padding: 8px 26px 8px 8px;
      border-radius: 10px;
      border: 1px solid #dddde3;
      font-size: 13px;
      outline: none;
      text-align: right;
      background: #f5f5f7;
      color: #777;
    }
    .input.editing {
      background: #fff;
      color: #111;
      border-color: var(--red);
      box-shadow: 0 0 0 1px rgba(255, 59, 48, 0.18);
    }
    .input:disabled { opacity: 1; }

    .goal-input-wrap span {
      position: absolute;
      right: 8px;
      top: 50%;
      transform: translateY(-50%);
      font-size: 12px;
      color: var(--text-sub);
    }

    .goal-actions {
      display: flex;
      gap: 8px;
      margin-left: 6px;
      flex-shrink: 0;
    }

    .btn {
      border: none;
      border-radius: 999px;
      padding: 8px 12px;
      font-size: 12px;
      font-weight: 900;
      cursor: pointer;
      transition: transform 0.15s ease-out, opacity 0.15s ease-out;
      user-select: none;
      white-space: nowrap;
    }
    .btn:active { transform: scale(0.96); }
    .btn.primary { background: var(--red); color: #fff; }
    .btn.ghost { background: #f0f0f3; color: #111; }
    .btn.hidden { display: none; }

    .goal-hint { margin-top: 6px; font-size: 11px; color: var(--text-sub); }

    .card {
      background: var(--card-bg);
      border-radius: var(--radius-card);
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 18px;
    }

    /* Calendar header with month switch */
    .calendar-top {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 10px;
    }
    .calendar-header {
      text-align: center;
      font-weight: 900;
      color: var(--text-main);
      flex: 1;
    }
    .month-btn {
      width: 34px;
      height: 34px;
      border-radius: 999px;
      border: none;
      background: #fff;
      box-shadow: 0 6px 14px rgba(0,0,0,0.08);
      cursor: pointer;
      font-size: 16px;
      font-weight: 900;
      color: #111;
    }
    .month-btn:active { transform: scale(0.95); }

    .calendar-grid {
      width: 100%;
      border-collapse: collapse;
      font-size: 13px;
      text-align: center;
      table-layout: fixed;
    }
    .calendar-grid th {
      padding: 6px 2px;
      font-weight: 900;
      color: #ffffff;
      background: var(--red);
      border-bottom: 1px solid #f27b71;
    }
    .calendar-grid td {
      padding: 6px 0;
      height: 32px;
      position: relative;
      background: #fff;
    }
    .calendar-grid tr:nth-child(n + 3) td { border-top: 1px solid #f4f4f6; }

    .calendar-grid td button.day {
      border: none;
      background: transparent;
      width: 28px;
      height: 28px;
      border-radius: 999px;
      font-size: 13px;
      cursor: pointer;
      position: relative;
      transition: background var(--transition-fast), color var(--transition-fast), transform 0.16s ease-out;
    }
    .calendar-grid td button.day.selected {
      background: var(--red);
      color: #fff;
      box-shadow: 0 4px 8px rgba(255, 59, 48, 0.36);
      transform: translateY(-1px);
    }

    .dot {
      width: 6px;
      height: 6px;
      border-radius: 50%;
      position: absolute;
      left: 50%;
      transform: translateX(-50%);
      bottom: 3px;
    }
    .dot.salary { background: #09b35c; }
    .dot.dividends { background: #ff2d92; }
    .dot.deposit { background: #7b61ff; }
    .dot.other { background: #ff9500; }

    .calendar-legend {
      display: flex;
      flex-wrap: wrap;
      row-gap: 4px;
      column-gap: 16px;
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
      justify-content: center;
    }
    .legend-item { display: inline-flex; align-items: center; gap: 5px; }
    .legend-marker { width: 10px; height: 10px; border-radius: 50%; }
    .legend-marker.salary { background: #09b35c; }
    .legend-marker.dividends { background: #ff2d92; }
    .legend-marker.deposit { background: #7b61ff; }
    .legend-marker.other { background: #ff9500; }

    /* chart */
    .chart-title { font-size: 12px; color: var(--text-sub); margin-bottom: 8px; padding-left: 2px; }
    .chart-wrapper {
      background: #181818;
      border-radius: 20px;
      padding: 14px 16px 20px;
      color: #fff;
      position: relative;
      overflow: hidden;
    }
    .chart-grid-lines { position: absolute; inset: 20px 16px 38px 36px; pointer-events: none; }
    .chart-grid-lines::before,
    .chart-grid-lines::after {
      content: "";
      position: absolute;
      inset: 0;
      border-radius: 12px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }
    .chart-y-labels {
      position: absolute;
      left: 10px;
      top: 24px;
      bottom: 42px;
      display: flex;
      flex-direction: column;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(255, 255, 255, 0.5);
    }
    svg#line-chart { width: 100%; height: 120px; display: block; }
    .chart-line {
      stroke: #f9d24a;
      stroke-width: 2;
      fill: none;
      stroke-linecap: round;
      stroke-linejoin: round;
      stroke-dasharray: 400;
      stroke-dashoffset: 400;
      transition: stroke-dashoffset 1.3s ease-out;
    }
    .chart-point { stroke: #181818; stroke-width: 2; transition: r 0.3s ease-out; }
    .chart-point.salary { fill: #09b35c; }
    .chart-point.dividends { fill: #ff2d92; }
    .chart-point.other { fill: #ff9500; }
    .chart-wrapper.loaded .chart-line { stroke-dashoffset: 0; }
    .chart-wrapper.loaded .chart-point { r: 5; }
    .chart-x-days {
      position: absolute;
      left: 36px;
      right: 16px;
      bottom: 8px;
      display: flex;
      justify-content: space-between;
      font-size: 9px;
      color: rgba(255, 255, 255, 0.6);
    }
    .chart-x-label { margin-top: 4px; font-size: 10px; color: rgba(255, 255, 255, 0.6); text-align: right; }

    /* recommendations */
    .reco-card {
      background: #fff9f3;
      border-radius: 22px;
      padding: 16px 16px 18px;
      box-shadow: var(--shadow-soft);
      color: var(--text-main);
      font-size: 12px;
      line-height: 1.45;
      margin-bottom: 12px;
    }
    .reco-title { color: var(--red); font-weight: 900; font-size: 13px; margin-bottom: 6px; text-align: center; }
    .reco-body { padding-top: 4px; }
    .reco-body strong { font-weight: 700; }

    /* forecast */
    .forecast-card {
      background: #ffffff;
      border-radius: 22px;
      padding: 14px 14px 10px;
      box-shadow: var(--shadow-soft);
      margin-bottom: 18px;
    }
    .forecast-title {
      color: var(--text-main);
      font-weight: 900;
      font-size: 13px;
      margin-bottom: 8px;
      text-align: center;
    }

    .forecast-meta {
      display:flex;
      gap:10px;
      align-items:center;
      justify-content: space-between;
      margin-bottom: 10px;
      flex-wrap: wrap;
    }

    .reach-date {
      font-size: 11px;
      color: var(--text-sub);
      font-weight: 700;
      flex: 1;
      min-width: 220px;
      text-align: left;
    }

    /* toggle */
    .segmented {
      display:inline-flex;
      background:#f2f2f5;
      border-radius:999px;
      padding:3px;
      box-shadow: inset 0 0 0 1px rgba(0,0,0,0.04);
    }
    .segmented button{
      border:none;
      background: transparent;
      padding:7px 10px;
      border-radius:999px;
      font-size:11px;
      font-weight: 900;
      color:#444;
      cursor:pointer;
      transition: transform .15s ease-out, background .2s ease-out, color .2s ease-out;
    }
    .segmented button:active{ transform: scale(0.98); }
    .segmented button.active{
      background:#fff;
      color:#111;
      box-shadow: 0 6px 12px rgba(0,0,0,0.08);
    }

    .forecast-scroll {
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
      border-radius: 16px;
    }
    .forecast-table {
      width: 100%;
      min-width: 560px;
      border-collapse: collapse;
      font-size: 12px;
    }
    .forecast-table th {
      text-align: left;
      padding: 10px 10px;
      color: #fff;
      background: var(--red);
      font-weight: 900;
      position: sticky;
      top: 0;
    }
    .forecast-table td {
      padding: 10px 10px;
      border-bottom: 1px solid #f0f0f3;
      white-space: nowrap;
      color: #222;
      font-weight: 700;
    }

    .forecast-row-goal {
      background: rgba(255, 59, 48, 0.07);
      position: relative;
      animation: goalPulse 2.2s ease-in-out infinite;
    }
    @keyframes goalPulse{
      0%{ box-shadow: inset 0 0 0 rgba(255,59,48,0); }
      50%{ box-shadow: inset 0 0 0 999px rgba(255,59,48,0.03); }
      100%{ box-shadow: inset 0 0 0 rgba(255,59,48,0); }
    }

    .forecast-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 10px;
      border-radius: 999px;
      font-size: 11px;
      font-weight: 900;
    }
    .badge-ok { background: rgba(9,179,92,0.12); color: #067a3e; }
    .badge-goal { background: rgba(255,59,48,0.12); color: #b81f17; }

    .forecast-note {
      margin-top: 8px;
      font-size: 11px;
      color: var(--text-sub);
      line-height: 1.35;
      text-align: center;
    }

    /* bottom nav */
    .bottom-nav {
      position: fixed;
      left: 50%;
      transform: translateX(-50%);
      bottom: 0;
      width: 100%;
      max-width: 430px;
      pointer-events: none;
      z-index: 20;
    }
    .bottom-nav-inner {
      background: #ffffff;
      box-shadow: 0 -1px 0 rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-around;
      align-items: center;
      padding: 6px 6px 8px;
      pointer-events: auto;
    }
    .nav-item {
      flex: 1; text-align: center;
      font-size: 11px;
      color: #9a9a9f;
      cursor: pointer;
      padding: 2px 0 0;
      user-select: none;
    }
    .nav-icon-wrap { margin-bottom: 2px; }
    .nav-item svg { display: block; margin: 0 auto; width: 24px; height: 24px; fill: #9a9a9f; }
    .nav-item span.label { display: block; }
    .nav-item.active { color: #000; font-weight: 700; }
    .nav-item.active svg { fill: #000; }
    .nav-item[data-tab="home"] svg { width: 26px; height: 26px; }

    .toast {
      position: fixed;
      left: 50%;
      bottom: 80px;
      transform: translateX(-50%) translateY(40px);
      max-width: 420px;
      width: calc(100% - 80px);
      padding: 10px 14px;
      background: #000;
      color: #fff;
      border-radius: 999px;
      font-size: 12px;
      text-align: center;
      box-shadow: 0 10px 24px rgba(0, 0, 0, 0.4);
      opacity: 0;
      transition: opacity 0.25s ease-out, transform 0.25s ease-out;
      z-index: 999;
      pointer-events: none;
    }
    .toast.visible { opacity: 1; transform: translateX(-50%) translateY(0); }

    @media (max-width: 360px) {
      .section-heading { font-size: 22px; }
      .everest-card { padding: 12px 12px 14px; }
      .info-inline { font-size: 12px; padding: 8px 10px; }
      .info-block strong { font-size: 14px; }
      .btn { padding: 7px 10px; font-size: 11px; }
      .reach-date { min-width: 160px; }
    }
  </style>
</head>

<body>
  <div class="app-shell" id="appShell">
    <header class="top-bar">
      <button class="back-btn" id="backButton" aria-label="Назад"><span>←</span></button>
      <div class="top-title" id="topTitle">Планирование</div>
    </header>

    <main class="app-scroll">
      <div class="screens">
        <!-- HOME -->
        <section class="screen screen-home active" data-tab="home">
          <h1 class="section-heading fade-in-up">Мой Аверест</h1>
          <div class="goal-title fade-in-up" id="goalTitleTop">Цель — 1 000 000 ₽</div>

          <section class="everest-card fade-in-up">
            <div class="everest-banner" id="everestBannerText">
              До новой машины осталось всего 2 зарплаты! Так держать!
            </div>

            <div style="display:flex; justify-content:center;">
              <div class="savings-pill" id="savingsPill">
                <span class="dot"></span>
                <span>Ваши накопления:</span>
                <span id="savingsAmountText">320 000 ₽</span>
              </div>
            </div>

            <div class="everest-inner">
              <div class="everest-image">
                <div class="goal-star" data-ratio="1">★</div>
                <div class="goal-star" data-ratio="0.8">★</div>
                <div class="goal-star" data-ratio="0.5">★</div>
                <div class="goal-star" data-ratio="0.3">★</div>
                <div class="goal-star" data-ratio="0.05">★</div>
              </div>

              <div class="everest-lines">
                <div class="everest-row" data-ratio="1"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.8"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.5"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.3"><div class="row-line"></div><div class="row-label amount-label"></div></div>
                <div class="everest-row" data-ratio="0.05"><div class="row-line"></div><div class="row-label amount-label"></div></div>
              </div>
            </div>

            <div class="progress-line" id="progressLine">Прогресс: 32%</div>
          </section>

          <div class="info-block fade-in-up">
            Планируемые поступления на <span id="plannedMonthName">январь</span>:
            <strong id="plannedAmountText">0 ₽</strong>
          </div>

          <!-- ближайшее зачисление (СИНХРОНИЗИРОВАНО С КАЛЕНДАРЕМ) -->
          <div class="info-inline fade-in-up">
            <span id="nextCreditText">Ближайшее зачисление —</span>
            <strong id="nextCreditAmount">—</strong>
          </div>

          <!-- Накопления -->
          <section class="goal-card fade-in-up">
            <div class="goal-row">
              <label for="savingsInput">Накопления</label>
              <div class="goal-input-wrap">
                <input id="savingsInput" class="input" type="text" inputmode="numeric" value="320000" disabled />
                <span>₽</span>
              </div>
              <div class="goal-actions">
                <button class="btn ghost" id="savingsEditBtn">Изменить</button>
                <button class="btn primary hidden" id="savingsApplyBtn">Принять</button>
              </div>
            </div>
            <div class="goal-hint">Фактическая сумма — влияет на звёзды, прогресс, прогноз и “осталось зарплат”.</div>
          </section>

          <!-- Цель -->
          <section class="goal-card fade-in-up">
            <div class="goal-row">
              <label for="goalInput">Цель</label>
              <div class="goal-input-wrap">
                <input id="goalInput" class="input" type="text" inputmode="numeric" value="1000000" disabled />
                <span>₽</span>
              </div>
              <div class="goal-actions">
                <button class="btn ghost" id="goalEditBtn">Изменить</button>
                <button class="btn primary hidden" id="goalApplyBtn">Принять</button>
              </div>
            </div>
            <div class="goal-hint">Сумма цели — влияет на шкалу справа и пороги звёзд.</div>
          </section>

          <!-- Зарплата -->
          <section class="goal-card fade-in-up">
            <div class="goal-row">
              <label for="salaryInput">Размер зарплаты</label>
              <div class="goal-input-wrap">
                <input id="salaryInput" class="input" type="text" inputmode="numeric" value="340000" disabled />
                <span>₽</span>
              </div>
              <div class="goal-actions">
                <button class="btn ghost" id="salaryEditBtn">Изменить</button>
                <button class="btn primary hidden" id="salaryApplyBtn">Принять</button>
              </div>
            </div>
            <div class="goal-hint">Используется для расчёта “осталось X зарплат” и прогноза по месяцам.</div>
          </section>

          <!-- Calendar -->
          <section class="card fade-in-up" id="calendarCard">
            <div class="calendar-top">
              <button class="month-btn" id="monthPrev" aria-label="Предыдущий месяц">‹</button>
              <div class="calendar-header" id="monthTitle">Январь</div>
              <button class="month-btn" id="monthNext" aria-label="Следующий месяц">›</button>
            </div>

            <table class="calendar-grid" aria-label="Календарь" id="calendarTable">
              <thead>
                <tr>
                  <th>П</th><th>В</th><th>С</th><th>Ч</th><th>П</th><th>С</th><th>В</th>
                </tr>
              </thead>
              <tbody id="calendarBody"></tbody>
            </table>

            <div class="calendar-legend">
              <div class="legend-item"><span class="legend-marker salary"></span> Зарплата</div>
              <div class="legend-item"><span class="legend-marker dividends"></span> Дивиденды</div>
              <div class="legend-item"><span class="legend-marker deposit"></span> % по вкладам</div>
              <div class="legend-item"><span class="legend-marker other"></span> Прочее</div>
            </div>
          </section>

          <!-- Chart -->
          <section class="card fade-in-up">
            <div class="chart-title">Изменения баланса</div>
            <div class="chart-wrapper" id="chartWrapper">
              <div class="chart-grid-lines"></div>
              <div class="chart-y-labels">
                <span>100 000</span>
                <span>52 000</span>
                <span>10 000</span>
                <span>1 000</span>
              </div>

              <svg id="line-chart" viewBox="0 0 260 120" role="img">
                <polyline id="balanceLine" class="chart-line" points=""></polyline>
                <g id="balancePoints"></g>
              </svg>

              <div class="chart-x-days" id="chartDays"></div>
              <div class="chart-x-label">Дни</div>
            </div>
          </section>

          <!-- Recommendations -->
          <section class="reco-card fade-in-up">
            <div class="reco-title">Рекомендации по использованию будущих средств:</div>
            <div class="reco-body">
              У вас сейчас стабильный приток средств. Рекомендуем направить часть будущих поступлений
              в накопления — от <strong>10% до 20%</strong>. Также можно увеличить долю инвестиций,
              чтобы ускорить рост капитала. Подумайте о создании финансовой подушки на
              <strong>3–6 месяцев</strong> расходов.
            </div>
          </section>

          <!-- Forecast -->
          <section class="forecast-card fade-in-up" id="forecastCard">
            <div class="forecast-title">Прогноз по месяцам</div>

            <div class="forecast-meta">
              <div class="reach-date" id="reachDateText">Цель будет достигнута: —</div>
              <div class="segmented" role="tablist" aria-label="Режим прогноза">
                <button id="modeSalaryBtn" class="active" type="button">Только зарплата</button>
                <button id="modeAllBtn" type="button">Все поступления</button>
              </div>
            </div>

            <div class="forecast-scroll">
              <table class="forecast-table" aria-label="Прогноз по месяцам">
                <thead>
                  <tr>
                    <th>Месяц</th>
                    <th>Ожидаемые поступления</th>
                    <th>Накопления (прогноз)</th>
                    <th>До цели</th>
                    <th>Статус</th>
                  </tr>
                </thead>
                <tbody id="forecastBody"></tbody>
              </table>
            </div>

            <div class="forecast-note" id="forecastNote">
              Прогноз строится на основе календаря и введённого размера зарплаты.
            </div>
          </section>
        </section>

        <!-- placeholders -->
        <section class="screen screen-placeholder" data-tab="payments"><h2>Платежи</h2><p>Экран в разработке.</p></section>
        <section class="screen screen-placeholder" data-tab="benefits"><h2>Выгода</h2><p>Экран в разработке.</p></section>
        <section class="screen screen-placeholder" data-tab="history"><h2>История</h2><p>Экран в разработке.</p></section>
        <section class="screen screen-placeholder" data-tab="chat"><h2>Чаты</h2><p>Экран в разработке.</p></section>
      </div>
    </main>

    <!-- bottom nav -->
    <nav class="bottom-nav">
      <div class="bottom-nav-inner">
        <div class="nav-item active" data-tab="home" data-title="Планирование">
          <div class="nav-icon-wrap">
            <svg viewBox="0 0 24 24"><path d="M4 11.5L12 4l8 7.5v7.5a1 1 0 0 1-1 1h-5v-6H10v6H5a1 1 0 0 1-1-1z"/><rect x="11" y="14" width="2" height="3" fill="#ffffff"/></svg>
          </div><span class="label">Главный</span>
        </div>
        <div class="nav-item" data-tab="payments" data-title="Платежи">
          <div class="nav-icon-wrap">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M9 8h4.2L11 5.8 12.2 4.5 16 8l-3.8 3.5L11 10.2 13.2 8H9z" fill="#ffffff"/><path d="M15 16H10.8L13 18.2 11.8 19.5 8 16l3.8-3.5L13 13.8 10.8 16H15z" fill="#ffffff"/></svg>
          </div><span class="label">Платежи</span>
        </div>
        <div class="nav-item" data-tab="benefits" data-title="Выгода">
          <div class="nav-icon-wrap">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 17.2s-3.4-2-4.6-3.8C6.7 12.4 6.5 11.5 6.5 10.8A2.8 2.8 0 0 1 9.3 8a3 3 0 0 1 2.2 1 3 3 0 0 1 2.2-1 2.8 2.8 0 0 1 2.8 2.8c0 .7-.2 1.6-0.9 2.6-1.2 1.8-4.6 3.8-4.6 3.8z" fill="#ffffff"/></svg>
          </div><span class="label">Выгода</span>
        </div>
        <div class="nav-item" data-tab="history" data-title="История">
          <div class="nav-icon-wrap">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M12 7v5.2l3 1.8-0.8 1.3-3.7-2.3V7z" fill="#ffffff"/></svg>
          </div><span class="label">История</span>
        </div>
        <div class="nav-item" data-tab="chat" data-title="Чаты">
          <div class="nav-icon-wrap">
            <svg viewBox="0 0 24 24"><circle cx="12" cy="12" r="10"/><path d="M8 9h8v4.5a2 2 0 0 1-2 2h-2.2L9 17.8V15H9a1 1 0 0 1-1-1z" fill="#ffffff"/><rect x="9" y="10" width="6" height="1.2" fill="#ffffff"/></svg>
          </div><span class="label">Чаты</span>
        </div>
      </div>
    </nav>

    <div class="toast" id="toast"></div>
  </div>

  <script>
    const backButton = document.getElementById("backButton");
    const topTitle = document.getElementById("topTitle");
    const chartWrapper = document.getElementById("chartWrapper");
    const toast = document.getElementById("toast");
    const navItems = Array.from(document.querySelectorAll(".nav-item"));
    const screens = Array.from(document.querySelectorAll(".screen"));
    const appShell = document.getElementById("appShell");

    const everestBannerText = document.getElementById("everestBannerText");
    const goalTitleTop = document.getElementById("goalTitleTop");
    const progressLine = document.getElementById("progressLine");
    const savingsAmountText = document.getElementById("savingsAmountText");

    const plannedMonthName = document.getElementById("plannedMonthName");
    const plannedAmountText = document.getElementById("plannedAmountText");

    const nextCreditText = document.getElementById("nextCreditText");
    const nextCreditAmount = document.getElementById("nextCreditAmount");

    const savingsInput = document.getElementById("savingsInput");
    const savingsEditBtn = document.getElementById("savingsEditBtn");
    const savingsApplyBtn = document.getElementById("savingsApplyBtn");

    const goalInput = document.getElementById("goalInput");
    const goalEditBtn = document.getElementById("goalEditBtn");
    const goalApplyBtn = document.getElementById("goalApplyBtn");

    const salaryInput = document.getElementById("salaryInput");
    const salaryEditBtn = document.getElementById("salaryEditBtn");
    const salaryApplyBtn = document.getElementById("salaryApplyBtn");

    const amountRows = Array.from(document.querySelectorAll(".everest-row"));
    const goalStars = Array.from(document.querySelectorAll(".goal-star"));

    const balanceLine = document.getElementById("balanceLine");
    const balancePointsGroup = document.getElementById("balancePoints");
    const chartDaysContainer = document.getElementById("chartDays");

    // Forecast elements
    const forecastBody = document.getElementById("forecastBody");
    const reachDateText = document.getElementById("reachDateText");
    const modeSalaryBtn = document.getElementById("modeSalaryBtn");
    const modeAllBtn = document.getElementById("modeAllBtn");

    // Calendar elements
    const calendarCard = document.getElementById("calendarCard");
    const monthTitle = document.getElementById("monthTitle");
    const monthPrev = document.getElementById("monthPrev");
    const monthNext = document.getElementById("monthNext");
    const calendarBody = document.getElementById("calendarBody");

    // Chart coords
    const CHART_LEFT = 36;
    const CHART_RIGHT = 244;
    const CHART_BOTTOM = 104;
    const CHART_TOP = 24;

    // State
    let savingsValue = 320000;
    let goalValue = 1000000;
    let salaryValue = 340000;

    let savingsEditing = false;
    let goalEditing = false;
    let salaryEditing = false;

    // Forecast mode: 'salary' or 'all'
    let forecastMode = "salary";

    // Months
    const MONTHS_RU = ["Январь","Февраль","Март","Апрель","Май","Июнь","Июль","Август","Сентябрь","Октябрь","Ноябрь","Декабрь"];
    const MONTHS_RU_GEN = ["январь","февраль","март","апрель","май","июнь","июль","август","сентябрь","октябрь","ноябрь","декабрь"];
    let currentMonthIndex = 0;
    const year = new Date().getFullYear();

    // Calendar events by month (0=Jan)
    const eventsByMonth = Array.from({length: 12}, () => ({}));
    eventsByMonth[0] = {
      17: { type: "salary",    amount: 52000 },
      19: { type: "other",     amount: 20000 },
      25: { type: "dividends", amount: 100000 }
    };

    function formatRuble(num) {
      const n = Number(num) || 0;
      return n.toLocaleString("ru-RU") + " ₽";
    }

    function parseNumberFromInput(value) {
      if (!value) return 0;
      const digits = value.toString().replace(/\D/g, "");
      return Number(digits || 0);
    }

    function pluralizeSalary(n) {
      const mod10 = n % 10;
      const mod100 = n % 100;
      if (mod100 >= 11 && mod100 <= 14) return "зарплат";
      if (mod10 === 1) return "зарплата";
      if (mod10 >= 2 && mod10 <= 4) return "зарплаты";
      return "зарплат";
    }

    function updateGoalTitle() {
      goalTitleTop.textContent = `Цель — ${formatRuble(goalValue)}`;
    }

    function updateProgressText() {
      const pct = goalValue > 0 ? Math.min(100, Math.max(0, Math.round((savingsValue / goalValue) * 100))) : 0;
      progressLine.textContent = `Прогресс: ${pct}%`;
    }

    function updateBannerBySalary() {
      const remaining = Math.max(goalValue - savingsValue, 0);
      const denom = Math.max(salaryValue, 1);
      const left = remaining === 0 ? 0 : Math.ceil(remaining / denom);
      const word = pluralizeSalary(left);
      everestBannerText.textContent = left === 0
        ? "Цель достигнута! Отличная работа!"
        : `До новой машины осталось всего ${left} ${word}! Так держать!`;
    }

    function applyStarsSequential() {
      goalStars.forEach((s) => s.classList.remove("delay-0","delay-1","delay-2","delay-3","delay-4"));
      const ordered = [...goalStars].sort((a,b)=>parseFloat(b.dataset.ratio)-parseFloat(a.dataset.ratio));
      ordered.forEach((star, idx) => {
        if (star.classList.contains("on")) star.classList.add(`delay-${Math.min(idx,4)}`);
      });
    }

    function recalcGoalUI() {
      amountRows.forEach((row) => {
        const ratio = parseFloat(row.dataset.ratio);
        const label = row.querySelector(".amount-label");
        if (!label || !ratio) return;
        const threshold = Math.round(goalValue * ratio);
        label.textContent = threshold ? formatRuble(threshold) : "0 ₽";
        row.dataset.threshold = threshold;
      });

      goalStars.forEach((star) => {
        const ratio = parseFloat(star.dataset.ratio);
        const threshold = Math.round(goalValue * ratio);
        const on = savingsValue >= threshold && threshold > 0;
        star.classList.toggle("on", on);
      });

      applyStarsSequential();
      updateProgressText();
      updateBannerBySalary();
      updateForecast();
      updateNextCredit();
      updatePlannedIncomesLabel();
    }

    function setEditing(input, editBtn, applyBtn, on) {
      input.disabled = !on;
      input.classList.toggle("editing", on);
      editBtn.classList.toggle("hidden", on);
      applyBtn.classList.toggle("hidden", !on);
      if (on) input.focus();
    }

    // Savings controls
    savingsEditBtn.addEventListener("click", () => {
      savingsEditing = true;
      savingsInput.value = String(savingsValue);
      setEditing(savingsInput, savingsEditBtn, savingsApplyBtn, true);
      showToast("Введите сумму накоплений и нажмите «Принять»");
    });
    savingsInput.addEventListener("input", () => {
      if (!savingsEditing) return;
      const v = parseNumberFromInput(savingsInput.value);
      savingsInput.value = v ? v.toLocaleString("ru-RU") : "";
    });
    savingsApplyBtn.addEventListener("click", () => {
      const v = parseNumberFromInput(savingsInput.value);
      savingsValue = Math.max(0, v);
      savingsInput.value = savingsValue.toLocaleString("ru-RU");
      savingsAmountText.textContent = formatRuble(savingsValue);
      savingsEditing = false;
      setEditing(savingsInput, savingsEditBtn, savingsApplyBtn, false);
      recalcGoalUI();
      showToast("Прогресс обновлён");
    });

    // Goal controls
    goalEditBtn.addEventListener("click", () => {
      goalEditing = true;
      goalInput.value = String(goalValue);
      setEditing(goalInput, goalEditBtn, goalApplyBtn, true);
      showToast("Введите новую цель и нажмите «Принять»");
    });
    goalInput.addEventListener("input", () => {
      if (!goalEditing) return;
      const v = parseNumberFromInput(goalInput.value);
      goalInput.value = v ? v.toLocaleString("ru-RU") : "";
    });
    goalApplyBtn.addEventListener("click", () => {
      const v = parseNumberFromInput(goalInput.value);
      if (v <= 0) { showToast("Цель должна быть больше 0"); return; }
      goalValue = v;
      goalInput.value = goalValue.toLocaleString("ru-RU");
      goalEditing = false;
      setEditing(goalInput, goalEditBtn, goalApplyBtn, false);
      updateGoalTitle();
      recalcGoalUI();
      showToast("Цель сохранена");
    });

    // Salary controls
    salaryEditBtn.addEventListener("click", () => {
      salaryEditing = true;
      salaryInput.value = String(salaryValue);
      setEditing(salaryInput, salaryEditBtn, salaryApplyBtn, true);
      showToast("Введите размер зарплаты и нажмите «Принять»");
    });
    salaryInput.addEventListener("input", () => {
      if (!salaryEditing) return;
      const v = parseNumberFromInput(salaryInput.value);
      salaryInput.value = v ? v.toLocaleString("ru-RU") : "";
    });
    salaryApplyBtn.addEventListener("click", () => {
      const v = parseNumberFromInput(salaryInput.value);
      if (v <= 0) { showToast("Зарплата должна быть больше 0"); return; }
      salaryValue = v;
      salaryInput.value = salaryValue.toLocaleString("ru-RU");
      salaryEditing = false;
      setEditing(salaryInput, salaryEditBtn, salaryApplyBtn, false);
      recalcGoalUI();
      showToast("Размер зарплаты сохранён");
    });

    // ===== Calendar =====
    function daysInMonth(y, m) { return new Date(y, m + 1, 0).getDate(); }
    function firstDayMondayIndex(y, m) {
      const d = new Date(y, m, 1);
      const js = d.getDay(); // Sun=0..Sat=6
      return (js + 6) % 7;   // Mon=0..Sun=6
    }

    function renderCalendar(monthIndex) {
      monthTitle.textContent = MONTHS_RU[monthIndex];

      const totalDays = daysInMonth(year, monthIndex);
      const offset = firstDayMondayIndex(year, monthIndex);

      const monthEvents = eventsByMonth[monthIndex] || {};
      calendarBody.innerHTML = "";

      let day = 1;
      for (let week = 0; week < 6; week++) {
        const tr = document.createElement("tr");

        for (let dow = 0; dow < 7; dow++) {
          const td = document.createElement("td");

          const cellIndex = week * 7 + dow;
          if (cellIndex < offset || day > totalDays) {
            td.innerHTML = "";
          } else {
            const btn = document.createElement("button");
            btn.className = "day";
            btn.textContent = day;

            const ev = monthEvents[day];
            if (ev) {
              btn.dataset.type = ev.type;
              btn.dataset.amount = String(ev.amount);
              const dot = document.createElement("span");
              dot.className = `dot ${ev.type}`;
              btn.appendChild(dot);
            }

            btn.addEventListener("click", () => {
              calendarBody.querySelectorAll(".day").forEach(b => b.classList.remove("selected"));
              btn.classList.add("selected");
              if (btn.dataset.type) {
                const t = btn.dataset.type;
                let text = "";
                if (t === "salary") text = "Зачисление зарплаты";
                if (t === "dividends") text = "Выплата дивидендов";
                if (t === "other") text = "Прочее поступление средств";
                if (text) showToast(text);
              }
            });

            td.appendChild(btn);
            day++;
          }

          tr.appendChild(td);
        }

        calendarBody.appendChild(tr);
        if (day > totalDays) break;
      }

      buildChartFromRenderedCalendar();
      chartWrapper.classList.remove("loaded");
      setTimeout(() => chartWrapper.classList.add("loaded"), 80);

      updatePlannedIncomesLabel();
      updateNextCredit();
      updateForecast();
    }

    function changeMonth(delta) {
      currentMonthIndex = Math.max(0, Math.min(11, currentMonthIndex + delta));
      renderCalendar(currentMonthIndex);
    }

    monthPrev.addEventListener("click", () => changeMonth(-1));
    monthNext.addEventListener("click", () => changeMonth(+1));

    // swipe calendar months
    let calStartX = null, calStartY = null;
    calendarCard.addEventListener("touchstart", (e) => {
      const t = e.touches[0];
      calStartX = t.clientX; calStartY = t.clientY;
    }, {passive:true});

    calendarCard.addEventListener("touchend", (e) => {
      if (calStartX == null || calStartY == null) return;
      const t = e.changedTouches[0];
      const dx = t.clientX - calStartX;
      const dy = t.clientY - calStartY;
      calStartX = calStartY = null;

      if (Math.abs(dx) < 40 || Math.abs(dx) < Math.abs(dy)) return;
      if (dx < 0) changeMonth(+1);
      else changeMonth(-1);
    }, {passive:true});

    // ===== Chart =====
    function buildChartFromRenderedCalendar() {
      const dayButtons = Array.from(document.querySelectorAll("#calendarBody .day[data-amount]"));

      const events = [];
      dayButtons.forEach((btn) => {
        const dayText = (btn.childNodes[0] && btn.childNodes[0].nodeType === 3)
          ? btn.childNodes[0].textContent
          : btn.textContent;
        const day = Number(String(dayText).trim());
        const amount = Number(btn.dataset.amount || 0);
        const type = btn.dataset.type || "other";
        if (!day || !amount) return;
        events.push({ day, amount, type });
      });

      if (!events.length) {
        balanceLine.setAttribute("points", "");
        balancePointsGroup.innerHTML = "";
        chartDaysContainer.innerHTML = "";
        return;
      }

      events.sort((a,b) => a.day - b.day);

      const maxDay = events[events.length - 1].day;
      const maxAmount = Math.max(...events.map(e => e.amount));
      const minAxis = 1000;

      const width = CHART_RIGHT - CHART_LEFT;
      const height = CHART_BOTTOM - CHART_TOP;
      const amountRange = (maxAmount - minAxis) || 1;

      function yForAmount(amount) {
        const clamped = Math.max(minAxis, amount);
        const ratio = (clamped - minAxis) / amountRange;
        return CHART_BOTTOM - ratio * height;
      }

      const circlesData = events.map(e => {
        const x = CHART_LEFT + (e.day / maxDay) * width;
        const y = yForAmount(e.amount);
        return { x, y, type: e.type, day: e.day };
      });

      const linePoints = circlesData.map(p => `${p.x.toFixed(1)},${p.y.toFixed(1)}`).join(" ");
      balanceLine.setAttribute("points", linePoints);

      balancePointsGroup.innerHTML = "";
      const svgNS = "http://www.w3.org/2000/svg";
      circlesData.forEach((p) => {
        const c = document.createElementNS(svgNS, "circle");
        c.setAttribute("cx", p.x.toFixed(1));
        c.setAttribute("cy", p.y.toFixed(1));
        c.setAttribute("r", "4");
        c.setAttribute("class", `chart-point ${p.type}`);
        balancePointsGroup.appendChild(c);
      });

      chartDaysContainer.innerHTML = "";
      circlesData.forEach((p) => {
        const span = document.createElement("span");
        span.textContent = p.day;
        chartDaysContainer.appendChild(span);
      });
    }

    // ===== Planned inflows label =====
    function monthIncome(monthIdx, mode) {
      const ev = eventsByMonth[monthIdx] || {};
      // Зарплата в прогнозе считаем как стабильную: 1 раз в месяц (salaryValue),
      // даже если в календаре нет события "salary" в этом месяце.
      let otherSum = 0;

      Object.keys(ev).forEach((day) => {
        const e = ev[day];
        if (!e) return;
        if (e.type !== "salary") otherSum += Number(e.amount || 0);
      });

      const salarySum = salaryValue; // 1 зарплата в месяц
      const total = (mode === "salary") ? salarySum : (salarySum + otherSum);

      return { otherSum, salarySum, total };
    }

    function updatePlannedIncomesLabel(){
      plannedMonthName.textContent = MONTHS_RU_GEN[currentMonthIndex];
      const inc = monthIncome(currentMonthIndex, forecastMode);
      plannedAmountText.textContent = formatRuble(inc.total);
    }

    // ===== Next credit line (NEW) =====
    function updateNextCredit() {
      const ev = eventsByMonth[currentMonthIndex] || {};
      const days = Object.keys(ev).map(d => Number(d)).sort((a,b)=>a-b);

      if (!days.length) {
        nextCreditText.textContent = "Ближайшее зачисление — нет запланированных";
        nextCreditAmount.textContent = "—";
        return;
      }

      const now = new Date();
      const todayMonth = now.getMonth();
      const todayDay = now.getDate();

      let nextDay = null;
      for (const d of days) {
        if (currentMonthIndex === todayMonth) {
          if (d >= todayDay) { nextDay = d; break; }
        } else {
          nextDay = d; break;
        }
      }
      // если месяц текущий и все события уже прошли — показываем первое событие (как “следующее в этом месяце” не найти)
      if (nextDay === null) nextDay = days[0];

      const event = ev[nextDay];
      const isSalary = event.type === "salary";
      const amount = isSalary ? salaryValue : Number(event.amount || 0);

      nextCreditText.textContent = `Ближайшее зачисление ${nextDay} ${MONTHS_RU_GEN[currentMonthIndex]}`;
      nextCreditAmount.textContent = formatRuble(amount);
    }

    // ===== Forecast (UPGRADED) =====
    function formatReachDate(monthIdx){
      const lastDay = new Date(year, monthIdx + 1, 0).getDate();
      return `${lastDay} ${MONTHS_RU_GEN[monthIdx]} ${year}`;
    }

    function updateForecast() {
      if (!forecastBody) return;

      forecastBody.innerHTML = "";

      let proj = savingsValue;
      let goalReachedMonth = -1;

      for (let m = currentMonthIndex; m < 12; m++) {
        const inc = monthIncome(m, forecastMode);
        proj = proj + inc.total;

        if (goalReachedMonth === -1 && proj >= goalValue) goalReachedMonth = m;
      }

      // reach date label
      if (goalReachedMonth === -1) {
        reachDateText.textContent = "Цель в этом году не будет достигнута (по текущему прогнозу)";
      } else {
        reachDateText.textContent = `Цель будет достигнута: ${formatReachDate(goalReachedMonth)}`;
      }

      // render rows (again, for correct per-row projection)
      proj = savingsValue;
      for (let m = currentMonthIndex; m < 12; m++) {
        const inc = monthIncome(m, forecastMode);
        proj = proj + inc.total;

        const remaining = Math.max(goalValue - proj, 0);

        const tr = document.createElement("tr");
        if (m === goalReachedMonth) tr.classList.add("forecast-row-goal");

        const tdMonth = document.createElement("td");
        tdMonth.textContent = MONTHS_RU[m];

        const tdInc = document.createElement("td");
        tdInc.textContent = formatRuble(inc.total);

        const tdProj = document.createElement("td");
        tdProj.textContent = formatRuble(proj);

        const tdRem = document.createElement("td");
        tdRem.textContent = remaining === 0 ? "0 ₽" : formatRuble(remaining);

        const tdStatus = document.createElement("td");
        const badge = document.createElement("span");
        badge.className = "forecast-badge " + (proj >= goalValue ? "badge-goal" : "badge-ok");
        badge.textContent = (proj >= goalValue)
          ? (m === goalReachedMonth ? "Месяц достижения" : "Цель достигнута")
          : "В процессе";
        tdStatus.appendChild(badge);

        tr.appendChild(tdMonth);
        tr.appendChild(tdInc);
        tr.appendChild(tdProj);
        tr.appendChild(tdRem);
        tr.appendChild(tdStatus);

        forecastBody.appendChild(tr);
      }
    }

    // Forecast mode toggles
    function setForecastMode(mode){
      forecastMode = mode;
      modeSalaryBtn.classList.toggle("active", mode === "salary");
      modeAllBtn.classList.toggle("active", mode === "all");
      updatePlannedIncomesLabel();
      updateForecast();
    }
    modeSalaryBtn.addEventListener("click", () => setForecastMode("salary"));
    modeAllBtn.addEventListener("click", () => setForecastMode("all"));

    // ===== Tabs / Swipe =====
    function setActiveTab(tab) {
      navItems.forEach((item) => item.classList.toggle("active", item.dataset.tab === tab));
      screens.forEach((screen) => screen.classList.toggle("active", screen.dataset.tab === tab));
      const activeNav = navItems.find((i) => i.dataset.tab === tab);
      if (activeNav && activeNav.dataset.title) topTitle.textContent = activeNav.dataset.title;
    }
    navItems.forEach((item) => item.addEventListener("click", () => setActiveTab(item.dataset.tab)));

    let touchStartX = null, touchStartY = null;
    const SWIPE_THRESHOLD = 40;
    function handleTouchStart(e) {
      const touch = e.touches[0];
      touchStartX = touch.clientX;
      touchStartY = touch.clientY;
    }
    function handleTouchEnd(e) {
      if (touchStartX === null || touchStartY === null) return;
      const touch = e.changedTouches[0];
      const dx = touch.clientX - touchStartX;
      const dy = touch.clientY - touchStartY;
      touchStartX = null; touchStartY = null;
      if (Math.abs(dx) < SWIPE_THRESHOLD || Math.abs(dx) < Math.abs(dy)) return;

      const currentIndex = navItems.findIndex((i) => i.classList.contains("active"));
      if (currentIndex === -1) return;

      let nextIndex = currentIndex;
      if (dx < 0 && currentIndex < navItems.length - 1) nextIndex = currentIndex + 1;
      else if (dx > 0 && currentIndex > 0) nextIndex = currentIndex - 1;

      if (nextIndex !== currentIndex) setActiveTab(navItems[nextIndex].dataset.tab);
    }
    appShell.addEventListener("touchstart", handleTouchStart, { passive: true });
    appShell.addEventListener("touchend", handleTouchEnd, { passive: true });

    // ===== Toast =====
    let toastTimeout;
    function showToast(message, duration = 2100) {
      toast.textContent = message;
      toast.classList.add("visible");
      clearTimeout(toastTimeout);
      toastTimeout = setTimeout(() => toast.classList.remove("visible"), duration);
    }

    // Back
    backButton.addEventListener("click", () => showToast("В реальном приложении здесь был бы переход назад 🙂"));

    // Init
    window.addEventListener("DOMContentLoaded", () => {
      document.querySelectorAll(".fade-in-up").forEach((el, index) => {
        setTimeout(() => el.classList.add("visible"), 120 * index);
      });

      savingsInput.value = savingsValue.toLocaleString("ru-RU");
      goalInput.value = goalValue.toLocaleString("ru-RU");
      salaryInput.value = salaryValue.toLocaleString("ru-RU");

      savingsAmountText.textContent = formatRuble(savingsValue);

      updateGoalTitle();
      recalcGoalUI();

      renderCalendar(currentMonthIndex);

      setTimeout(() => chartWrapper.classList.add("loaded"), 700);
      setTimeout(() => showToast("Свайп влево/вправо переключает вкладки внизу"), 1200);
      setTimeout(() => showToast("Свайп по календарю — листает месяцы"), 3200);
    });
  </script>
</body>
</html>